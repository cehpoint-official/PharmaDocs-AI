<!--Copyright (C) 2025 Soumyadeep Ghosh <soumyadeepghosh2004@zohomail.in> -->
<!--All Rights Reserved-->

{% extends "base.html" %}

{% block title %}{{ document.title }} - PharmaDocs AI Platform{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

  <!-- Breadcrumb + Header -->
  <div class="flex flex-col md:flex-row md:items-end md:justify-between mb-8 space-y-4 md:space-y-0">
    <div class="space-y-1">
      <nav class="flex items-center space-x-2 text-[10px] font-black uppercase tracking-widest text-gray-400 mb-2">
        <a href="{{ url_for('dashboard.user_dashboard') }}" class="hover:text-blue-600 transition-colors">Dashboard</a>
        <i class="fas fa-chevron-right text-[8px]"></i>
        {% if document.document_type == 'AMV_VERIFICATION' %}
        <a href="{{ url_for('amv_bp.list_amv_verification_documents') }}"
          class="hover:text-blue-600 transition-colors">Verification</a>
        {% else %}
        <a href="{{ url_for('amv_bp.list_amv_documents') }}" class="hover:text-blue-600 transition-colors">AMV
          Archive</a>
        {% endif %}
        <i class="fas fa-chevron-right text-[8px]"></i>
        <span class="text-blue-600">{{ document.document_number or 'Unassigned' }}</span>
      </nav>
      <div class="flex items-center gap-3">
        <div class="w-1.5 h-8 bg-blue-600 rounded-full"></div>
        <h1 class="text-3xl font-black text-gray-900 tracking-tight">{{ document.title }}</h1>
      </div>
      <p class="text-sm font-bold text-gray-500 ml-4">{{ document.document_type.replace('_', ' ').title() }} Protocol
      </p>
    </div>

    <div class="flex items-center gap-3">
      {% if document.status == 'draft' %}
      <button id="generateDocumentBtn" data-document-id="{{ document.id }}"
        data-document-type="{{ document.document_type }}"
        class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white text-xs font-black uppercase tracking-widest rounded-xl shadow-lg shadow-blue-200 transition-all transform hover:-translate-y-0.5 active:scale-95">
        <i class="fas fa-sparkles mr-2 text-[10px]"></i>
        <span>Execute Generation</span>
      </button>
      {% endif %}
    </div>
  </div>

  <!-- Perspective Grid -->
  <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">

    <!-- LEFT COLUMN: Main Info -->
    <div class="lg:col-span-8 space-y-8">

      <!-- Primary Matrix Card -->
      <div class="bg-white/70 backdrop-blur-xl border border-white/40 shadow-2xl rounded-3xl overflow-hidden">
        <div class="px-8 py-6 border-b border-gray-100 flex items-center justify-between bg-white/50">
          <h2 class="text-xs font-black text-gray-900 uppercase tracking-widest flex items-center">
            <span class="bg-blue-600 w-2 h-2 rounded-full mr-3 animate-pulse"></span>
            Matrix Specifications
          </h2>
          <div class="flex items-center gap-2">
            {% if document.status == 'completed' %}
            <span
              class="px-3 py-1 bg-green-500/10 text-green-600 border border-green-500/20 rounded-full text-[10px] font-black uppercase tracking-tighter shadow-sm whitespace-nowrap">
              <i class="fas fa-check-double mr-1 text-[8px]"></i> Certified
            </span>
            {% elif document.status == 'generated' %}
            <span
              class="px-3 py-1 bg-blue-500/10 text-blue-600 border border-blue-500/20 rounded-full text-[10px] font-black uppercase tracking-tighter shadow-sm whitespace-nowrap">
              <i class="fas fa-file-export mr-1 text-[8px]"></i> Exported
            </span>
            {% else %}
            <span
              class="px-3 py-1 bg-orange-500/10 text-orange-600 border border-orange-500/20 rounded-full text-[10px] font-black uppercase tracking-tighter shadow-sm whitespace-nowrap">
              <i class="fas fa-pen-nib mr-1 text-[8px]"></i> Draft Mode
            </span>
            {% endif %}
          </div>
        </div>

        <div class="p-8">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-8">
            <!-- Data Point -->
            <div class="space-y-1 group">
              <p
                class="text-[9px] font-black text-gray-400 uppercase tracking-[0.2em] transition-colors group-hover:text-blue-500">
                Registry ID</p>
              <p class="text-sm font-bold text-gray-800 font-mono">{{ document.document_number or 'PENDING_REG_001' }}
              </p>
            </div>

            <!-- Data Point -->
            <div class="space-y-1 group">
              <p
                class="text-[9px] font-black text-gray-400 uppercase tracking-[0.2em] transition-colors group-hover:text-blue-500">
                Affiliated Entity</p>
              <div class="flex items-center gap-3">
                {% if document.company.logo_url %}
                <img src="{{ document.company.logo_url }}"
                  class="w-6 h-6 rounded-lg object-contain bg-gray-50 border p-0.5">
                {% else %}
                <div class="w-6 h-6 bg-blue-50 rounded-lg flex items-center justify-center border border-blue-100">
                  <i class="fas fa-building text-blue-400 text-[10px]"></i>
                </div>
                {% endif %}
                <span class="text-sm font-bold text-gray-800">{{ document.company.name }}</span>
              </div>
            </div>

            <!-- Context Specific Details -->
            {% if document.document_type == 'AMV' and amv_details %}
            <div class="space-y-1 group">
              <p
                class="text-[9px] font-black text-gray-400 uppercase tracking-[0.2em] transition-colors group-hover:text-blue-500">
                Target Product</p>
              <p class="text-sm font-bold text-gray-800">{{ amv_details.product_name }}</p>
            </div>
            <div class="space-y-1 group">
              <p
                class="text-[9px] font-black text-gray-400 uppercase tracking-[0.2em] transition-colors group-hover:text-blue-500">
                Active Compound</p>
              <p class="text-sm font-bold text-blue-700">{{ amv_details.active_ingredient }}</p>
            </div>
            {% elif document.document_type == 'AMV_VERIFICATION' and amv_verification %}
            <div class="space-y-1 group">
              <p
                class="text-[9px] font-black text-gray-400 uppercase tracking-[0.2em] transition-colors group-hover:text-blue-500">
                Verification Target</p>
              <p class="text-sm font-bold text-gray-800">{{ amv_verification.product_name }}</p>
            </div>
            <div class="space-y-1 group">
              <p
                class="text-[9px] font-black text-gray-400 uppercase tracking-[0.2em] transition-colors group-hover:text-blue-500">
                Methodology</p>
              <p class="text-sm font-bold text-indigo-600">{{ amv_verification.test_method }}</p>
            </div>
            {% endif %}

            <!-- Temporal Data -->
            <div class="space-y-1 group">
              <p
                class="text-[9px] font-black text-gray-400 uppercase tracking-[0.2em] transition-colors group-hover:text-blue-500">
                Initialization</p>
              <p class="text-sm font-bold text-gray-800">{{ document.created_at.strftime("%b %d, %Y") }} <span
                  class="text-[10px] text-gray-400 ml-1 font-normal">{{ document.created_at.strftime("%H:%M") }}</span>
              </p>
            </div>
            <div class="space-y-1 group">
              <p
                class="text-[9px] font-black text-gray-400 uppercase tracking-[0.2em] transition-colors group-hover:text-blue-500">
                Last Synchronization</p>
              <p class="text-sm font-bold text-gray-800">{{ document.updated_at.strftime("%b %d, %Y") }} <span
                  class="text-[10px] text-gray-400 ml-1 font-normal">{{ document.updated_at.strftime("%H:%M") }}</span>
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Asset Manifest Section -->
      <div class="bg-white/60 backdrop-blur-xl border border-white/40 shadow-xl rounded-3xl overflow-hidden">
        <div class="px-8 py-5 border-b border-gray-100 flex items-center bg-white/40">
          <h2 class="text-xs font-black text-gray-900 uppercase tracking-widest flex items-center">
            <i class="fas fa-layer-group mr-3 text-blue-500"></i>
            Attachment Manifest
          </h2>
        </div>
        <div class="p-6">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            {% if document.method_analysis_file_url %}
            <div
              class="bg-white p-4 rounded-2xl border border-gray-100 hover:border-blue-200 transition-all group flex items-center shadow-sm">
              <div
                class="w-10 h-10 bg-red-50 rounded-xl flex items-center justify-center mr-4 group-hover:bg-red-100 transition-colors">
                <i class="fas fa-file-pdf text-red-500"></i>
              </div>
              <div class="flex-grow min-w-0">
                <h4 class="text-xs font-black text-gray-800 uppercase tracking-tight truncate">Method Analysis</h4>
                <a href="{{ document.method_analysis_file_url }}" target="_blank"
                  class="text-[10px] font-bold text-blue-600 hover:underline">ACCESS ASSET</a>
              </div>
            </div>
            {% endif %}

            {% if document.stp_file_url %}
            <div
              class="bg-white p-4 rounded-2xl border border-gray-100 hover:border-blue-200 transition-all group flex items-center shadow-sm">
              <div
                class="w-10 h-10 bg-blue-50 rounded-xl flex items-center justify-center mr-4 group-hover:bg-blue-100 transition-colors">
                <i class="fas fa-file-word text-blue-500"></i>
              </div>
              <div class="flex-grow min-w-0">
                <h4 class="text-xs font-black text-gray-800 uppercase tracking-tight truncate">STP Protocol</h4>
                <a href="{{ document.stp_file_url }}" target="_blank"
                  class="text-[10px] font-bold text-blue-600 hover:underline">ACCESS ASSET</a>
              </div>
            </div>
            {% endif %}

            {% if document.raw_data_url %}
            <div
              class="bg-white p-4 rounded-2xl border border-gray-100 hover:border-blue-200 transition-all group flex items-center shadow-sm">
              <div
                class="w-10 h-10 bg-green-50 rounded-xl flex items-center justify-center mr-4 group-hover:bg-green-100 transition-colors">
                <i class="fas fa-file-excel text-green-600"></i>
              </div>
              <div class="flex-grow min-w-0">
                <h4 class="text-xs font-black text-gray-800 uppercase tracking-tight truncate">Raw Analytical Data</h4>
                <a href="{{ document.raw_data_url }}" target="_blank"
                  class="text-[10px] font-bold text-green-600 hover:underline">ACCESS ASSET</a>
              </div>
            </div>
            {% endif %}

            {% if not document.method_analysis_file_url and not document.stp_file_url and not document.raw_data_url %}
            <div class="col-span-full py-8 text-center bg-gray-50/50 rounded-2xl border border-dashed border-gray-200">
              <i class="fas fa-cloud-upload-alt text-gray-300 text-3xl mb-3"></i>
              <p class="text-xs font-bold text-gray-400 uppercase tracking-widest">No attached assets found</p>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT COLUMN: Sidebar -->
    <div class="lg:col-span-4 space-y-8">

      <!-- Deployment Control -->
      <div class="bg-white/80 backdrop-blur-xl border border-white/40 shadow-2xl rounded-3xl overflow-hidden">
        <div class="px-6 py-5 border-b border-gray-100 bg-white/50">
          <h2 class="text-xs font-black text-gray-900 uppercase tracking-widest">Deployment Control</h2>
        </div>
        <div class="p-6 space-y-4">
          {% if document.generated_doc_url %}
          <div class="space-y-3">
            {% if document.document_type == 'AMV_VERIFICATION' %}
            <a href="{{ url_for('amv_bp.download_verification_protocol', document_id=document.id) }}"
              class="w-full flex items-center justify-center p-4 bg-blue-50 text-blue-700 rounded-2xl border border-blue-100 font-black text-xs uppercase tracking-widest hover:bg-blue-100 transition-all group">
              <i class="fas fa-file-word mr-3 text-lg group-hover:scale-110 transition-transform"></i>
              Verification Word
            </a>
            {% else %}
            <a href="{{ url_for('amv_bp.download_amv_report', document_id=document.id) }}"
              class="w-full flex items-center justify-center p-4 bg-blue-50 text-blue-700 rounded-2xl border border-blue-100 font-black text-xs uppercase tracking-widest hover:bg-blue-100 transition-all group">
              <i class="fas fa-file-word mr-3 text-lg group-hover:scale-110 transition-transform"></i>
              AMV Report Word
            </a>
            {% endif %}

            {% if document.generated_excel_url %}
            <a href="{{ document.generated_excel_url }}" target="_blank"
              class="w-full flex items-center justify-center p-4 bg-green-50 text-green-700 rounded-2xl border border-green-100 font-black text-xs uppercase tracking-widest hover:bg-green-100 transition-all group">
              <i class="fas fa-file-excel mr-3 text-lg group-hover:scale-110 transition-transform"></i>
              Analytical Excel
            </a>
            {% endif %}
          </div>
          {% else %}
          <div class="py-12 bg-gray-50/50 rounded-2xl border border-dashed border-gray-200 text-center px-4">
            <div
              class="w-16 h-16 bg-white rounded-full flex items-center justify-center mx-auto mb-4 border border-gray-200 shadow-sm">
              <i class="fas fa-file-signature text-gray-300 text-2xl"></i>
            </div>
            <h3 class="text-sm font-black text-gray-700 uppercase tracking-tight mb-2">Awaiting Generation</h3>
            <p class="text-[10px] text-gray-400 font-bold uppercase leading-relaxed mb-6">Initialize the AI computation
              matrix to generate regulatory files.</p>
            {% if document.status == 'draft' %}
            <button id="generateDocumentBtnAlt" data-document-id="{{ document.id }}"
              data-document-type="{{ document.document_type }}"
              class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white text-[10px] font-black uppercase tracking-[0.2em] rounded-xl shadow-md transition-all active:scale-95">
              Force Initialize
            </button>
            {% endif %}
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Quick Parameters -->
      {% if metadata %}
      <div class="bg-white/60 backdrop-blur-xl border border-white/40 shadow-xl rounded-3xl overflow-hidden">
        <div class="px-6 py-5 border-b border-gray-100 bg-white/40">
          <h2 class="text-xs font-black text-gray-900 uppercase tracking-widest">Metadata Tags</h2>
        </div>
        <div class="p-6">
          <div class="flex flex-wrap gap-2">
            {% for key, value in metadata.items() %}
            {% if value and key not in ['document_type', 'title', 'company_id'] %}
            <div class="px-3 py-1.5 bg-white border border-gray-100 rounded-lg shadow-sm flex flex-col">
              <span class="text-[8px] font-black text-gray-400 uppercase tracking-tighter">{{ key.replace('_', ' ')
                }}</span>
              <span class="text-[10px] font-bold text-gray-800">{{ value }}</span>
            </div>
            {% endif %}
            {% endfor %}
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Cleanup Activity -->
      {% if document.stp_file_url or document.raw_data_url or document.method_analysis_file_url %}
      <div class="bg-orange-50/50 border border-orange-100 rounded-3xl p-6 text-center">
        <h4 class="text-xs font-black text-orange-800 uppercase tracking-widest mb-2">Asset Maintenance</h4>
        <p class="text-[10px] text-orange-600 font-bold uppercase mb-4 leading-relaxed">System uploaded files occupy
          cloud storage. Execute cleanup after documentation is finalized.</p>
        <button id="cleanupFilesBtn" data-document-id="{{ document.id }}"
          class="w-full py-2 border border-orange-200 text-orange-600 bg-white hover:bg-orange-600 hover:text-white transition-all text-[10px] font-black uppercase tracking-widest rounded-xl">
          Cleanup Matrix
        </button>
      </div>
      {% endif %}

      <!-- Critical Deletion -->
      <button id="deleteDocumentBtn" data-document-id="{{ document.id }}"
        data-document-type="{{ document.document_type }}"
        class="w-full py-3 text-red-500 hover:text-white hover:bg-red-500 border border-red-200 transition-all text-xs font-black uppercase tracking-widest rounded-2xl flex items-center justify-center gap-2">
        <i class="fas fa-trash-alt text-[10px]"></i>
        Purge Record
      </button>
    </div>
  </div>
</div>

<!-- Generation Progress Modal -->
<div id="generationModal" class="hidden fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-50 z-50">
  <div class="bg-white rounded-lg shadow-lg max-w-md w-full p-6 text-center">
    <h3 class="text-lg font-semibold mb-4">Generating Document</h3>
    <div class="flex justify-center mb-4">
      <div class="w-10 h-10 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
    </div>
    <p class="text-gray-600 mb-4">Processing your document. This may take a few moments...</p>
    <div class="w-full bg-gray-200 rounded-full h-2">
      <div class="bg-indigo-500 h-2 rounded-full animate-pulse w-full"></div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="hidden fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-50 z-50">
  <div class="bg-white rounded-lg shadow-lg max-w-md w-full p-6">
    <h3 class="text-lg font-semibold mb-4 text-red-600">Confirm Deletion</h3>
    <p class="text-gray-600 mb-6">Are you sure you want to delete this document? This action cannot be undone.</p>
    <div class="flex justify-end space-x-3">
      <button id="cancelDeleteBtn" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100">
        Cancel
      </button>
      <button id="confirmDeleteBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
        Delete Document
      </button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Delete functionality
    const deleteBtn = document.getElementById('deleteDocumentBtn');
    const deleteModal = document.getElementById('deleteModal');
    const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

    let documentIdToDelete = null;

    if (deleteBtn) {
      deleteBtn.addEventListener('click', function () {
        documentIdToDelete = this.dataset.documentId;
        deleteModal.classList.remove('hidden');
      });
    }

    if (cancelDeleteBtn) {
      cancelDeleteBtn.addEventListener('click', function () {
        deleteModal.classList.add('hidden');
        documentIdToDelete = null;
      });
    }

    if (confirmDeleteBtn) {
      confirmDeleteBtn.addEventListener('click', function () {
        if (documentIdToDelete) {
          // Show loading state
          confirmDeleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Deleting...';
          confirmDeleteBtn.disabled = true;

          fetch(`/amv/${documentIdToDelete}/delete`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
          })
            .then(response => {
              if (response.redirected) {
                // ✅ FOLLOW THE REDIRECT TO DASHBOARD
                window.location.href = response.url;
              } else if (response.ok) {
                // ✅ FALLBACK: REDIRECT TO DASHBOARD
                window.location.href = "{{ url_for('dashboard.user_dashboard') }}";
              } else {
                throw new Error('Delete failed');
              }
            })
            .catch(error => {
              console.error('Error:', error);
              alert('Error deleting document');
              deleteModal.classList.add('hidden');
              // Reset button
              confirmDeleteBtn.innerHTML = 'Delete Document';
              confirmDeleteBtn.disabled = false;
            });
        }
      });
    }

    // Generation functionality
    const generateBtns = document.querySelectorAll('[id^="generateDocumentBtn"]');
    const generationModal = document.getElementById('generationModal');

    generateBtns.forEach(btn => {
      btn.addEventListener('click', function () {
        const documentId = this.dataset.documentId;
        const documentType = this.dataset.documentType;

        generationModal.classList.remove('hidden');

        // Determine the correct generation endpoint based on document type
        let endpoint;
        if (documentType === 'AMV_VERIFICATION') {
          endpoint = `/amv/verification/${documentId}/generate`;
        } else {
          endpoint = `/amv/${documentId}/generate-report`;
        }

        fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
        })
          .then(response => {
            if (response.ok) {
              return response.blob();
            } else {
              throw new Error('Generation failed');
            }
          })
          .then(blob => {
            generationModal.classList.add('hidden');
            window.location.reload(); // Reload to show the new download links
          })
          .catch(error => {
            generationModal.classList.add('hidden');
            alert('Error generating document: ' + error.message);
          });
      });
    });

    // Close modals when clicking outside
    document.addEventListener('click', function (event) {
      if (event.target === deleteModal) {
        deleteModal.classList.add('hidden');
      }
      if (event.target === generationModal) {
        generationModal.classList.add('hidden');
      }
    });

    // Escape key to close modals
    document.addEventListener('keydown', function (event) {
      if (event.key === 'Escape') {
        deleteModal.classList.add('hidden');
        generationModal.classList.add('hidden');
      }
    });
  });
</script>
{% endblock %}