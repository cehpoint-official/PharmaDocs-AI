{% extends "base.html" %}
{% block title %}Subscription Plans - PharmaDocs AI (India){% endblock %}

{% block content %}
<div class="px-6 py-6 max-w-7xl mx-auto">
    <!-- Header -->
    <div class="text-center mb-12">
        <h1 class="text-4xl font-bold text-gray-900 mb-4">Choose Your Plan</h1>
        <p class="text-xl text-gray-600">Select the perfect plan for your pharmaceutical documentation needs</p>
        <div class="mt-4 inline-flex items-center px-3 py-1 rounded-full text-sm bg-green-100 text-green-800">
            <i class="fas fa-map-marker-alt mr-2"></i>
            India - All prices in ₹ (INR)
        </div>
    </div>

    <!-- Setup Instructions (show if no Razorpay key) -->
    {% if not razorpay_key_id %}
    <div class="bg-orange-50 border border-orange-200 rounded-lg p-6 mb-8">
        <div class="flex items-start">
            <div class="flex-shrink-0">
                <i class="fas fa-exclamation-triangle text-orange-400 mt-1"></i>
            </div>
            <div class="ml-3">
                <h3 class="text-lg font-medium text-orange-800">Setup Required</h3>
                <p class="mt-2 text-sm text-orange-700">
                    To enable payments, please add your Razorpay credentials to the .env file:
                </p>
                <div class="mt-3 bg-orange-100 p-3 rounded text-sm font-mono text-orange-900">
                    RAZORPAY_KEY_ID=rzp_test_your_key_id_here<br>
                    RAZORPAY_KEY_SECRET=your_secret_key_here
                </div>
                <p class="mt-2 text-sm text-orange-700">
                    Get your free test credentials from <a href="https://razorpay.com" target="_blank" class="underline font-medium">razorpay.com</a>
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Current Plan Info -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="text-lg font-semibold text-blue-900">Current Plan: {{ user.subscription_plan.title() }}</h3>
                <p class="text-blue-700">
                    {% if user.subscription_expiry and user.subscription_expiry > now %}
                        Expires on {{ user.subscription_expiry.strftime('%B %d, %Y') }}
                    {% elif user.subscription_plan == 'free' %}
                        No expiration date
                    {% else %}
                        Subscription expired
                    {% endif %}
                </p>
            </div>
            <div class="text-right">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium
                    {% if user.subscription_plan == 'premium' %}bg-green-100 text-green-800
                    {% elif user.subscription_plan == 'basic' %}bg-blue-100 text-blue-800
                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                    {% if user.is_subscription_active() %}Active{% else %}Inactive{% endif %}
                </span>
            </div>
        </div>
    </div>

    <!-- Subscription Plans -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
        {% for plan in plans %}
        <div class="bg-white rounded-2xl shadow-lg border-2 
            {% if plan.popular %}border-blue-500{% else %}border-gray-200{% endif %} p-8 relative">
            
            {% if plan.popular %}
            <div class="absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-1/2">
                <span class="bg-blue-500 text-white px-4 py-1 text-sm font-medium rounded-full">Most Popular</span>
            </div>
            {% endif %}
            
            <div class="text-center">
                <h3 class="text-2xl font-bold text-gray-900">{{ plan.display_name }}</h3>
                <div class="mt-4">
                    <span class="text-4xl font-bold text-gray-900">₹{{ plan.price|int }}</span>
                    <span class="text-gray-500">/month</span>
                </div>
            </div>
            
            <ul class="mt-8 space-y-4">
                {% for feature in plan.features %}
                <li class="flex items-center">
                    <i class="fas fa-check text-green-500 mr-3"></i>
                    <span>{{ feature }}</span>
                </li>
                {% endfor %}
            </ul>
            
            <div class="mt-8">
                {% if user.subscription_plan == plan.name %}
                    <button class="w-full py-3 px-6 
                        {% if plan.name == 'premium' %}bg-green-400 text-white
                        {% elif plan.name == 'basic' %}bg-blue-400 text-white
                        {% else %}bg-gray-400 text-white{% endif %} 
                        font-medium rounded-lg cursor-not-allowed">
                        Current Plan
                    </button>
                {% elif plan.name == 'free' %}
                    <button onclick="downgradePlan('free')" class="w-full py-3 px-6 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-lg transition">
                        Downgrade
                    </button>
                {% else %}
                    <button onclick="subscribeToPlan('{{ plan.name }}', {{ plan.price|int * 100 }})" 
                            class="w-full py-3 px-6 
                            {% if plan.name == 'premium' %}bg-green-600 hover:bg-green-700
                            {% else %}bg-blue-600 hover:bg-blue-700{% endif %} 
                            text-white font-medium rounded-lg transition">
                        Choose {{ plan.display_name }}
                    </button>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Payment Methods -->
    <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
        <h3 class="text-2xl font-bold text-gray-900 mb-6 text-center">Accepted Payment Methods</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-6 items-center justify-center">
            <div class="text-center">
                <i class="fab fa-cc-visa text-4xl text-blue-600 mb-2"></i>
                <p class="text-sm text-gray-600">Visa</p>
            </div>
            <div class="text-center">
                <i class="fab fa-cc-mastercard text-4xl text-red-600 mb-2"></i>
                <p class="text-sm text-gray-600">Mastercard</p>
            </div>
            <div class="text-center">
                <i class="fas fa-university text-4xl text-green-600 mb-2"></i>
                <p class="text-sm text-gray-600">Net Banking</p>
            </div>
            <div class="text-center">
                <i class="fas fa-mobile-alt text-4xl text-purple-600 mb-2"></i>
                <p class="text-sm text-gray-600">UPI</p>
            </div>
        </div>
        <div class="mt-4 text-center">
            <p class="text-sm text-gray-500">Powered by Razorpay - India's leading payment gateway</p>
        </div>
    </div>

    <!-- FAQ Section -->
    <div class="bg-white rounded-lg shadow-lg p-8">
        <h3 class="text-2xl font-bold text-gray-900 mb-6">Frequently Asked Questions</h3>
        
        <div class="space-y-6">
            <div class="border-b border-gray-200 pb-4">
                <h4 class="text-lg font-semibold text-gray-900 mb-2">Can I pay in Indian Rupees?</h4>
                <p class="text-gray-600">Yes! All our plans are priced in Indian Rupees (₹) and we accept all Indian payment methods including UPI, Net Banking, Cards, and Wallets.</p>
            </div>
            
            <div class="border-b border-gray-200 pb-4">
                <h4 class="text-lg font-semibold text-gray-900 mb-2">Is there a free trial?</h4>
                <p class="text-gray-600">New users get a 7-day free trial on Basic and Premium plans. You can cancel anytime during the trial period.</p>
            </div>
            
            <div class="border-b border-gray-200 pb-4">
                <h4 class="text-lg font-semibold text-gray-900 mb-2">Which payment methods are supported?</h4>
                <p class="text-gray-600">We support UPI, Net Banking, Credit/Debit Cards, and popular wallets like Paytm, PhonePe through Razorpay's secure platform.</p>
            </div>
            
            <div>
                <h4 class="text-lg font-semibold text-gray-900 mb-2">Can I get a tax invoice?</h4>
                <p class="text-gray-600">Yes, we provide GST-compliant invoices for all payments. You can download them from your billing history.</p>
            </div>
        </div>
    </div>
</div>

<!-- Payment Processing Modal -->
<div id="paymentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-900">Complete Payment</h3>
            <button onclick="closePaymentModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div id="paymentDetails" class="mb-4">
            <p class="text-gray-600">Plan: <span id="selectedPlanName" class="font-semibold"></span></p>
            <p class="text-gray-600">Amount: ₹<span id="selectedAmount" class="font-semibold"></span></p>
        </div>
        
        <div class="space-y-3">
            <button id="razorpayButton" class="w-full py-3 px-6 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition">
                <i class="fas fa-credit-card mr-2"></i>Pay with Razorpay
            </button>
            
            <button id="paymentLinkButton" class="w-full py-3 px-6 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition">
                <i class="fas fa-link mr-2"></i>Get Payment Link
            </button>
            
            <p class="text-sm text-gray-500 mt-4">
                <strong>Note:</strong> To test payments, you need to add Razorpay credentials to your .env file first.
            </p>
        </div>
        
        <div id="payment-result" class="hidden mt-4"></div>
    </div>
</div>

<!-- Payment Success Modal -->
<div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full mx-4 text-center">
        <div class="mb-4">
            <i class="fas fa-check-circle text-green-500 text-5xl mb-4"></i>
            <h3 class="text-2xl font-bold text-gray-900 mb-2">Payment Successful!</h3>
            <p class="text-gray-600">Your subscription has been activated successfully.</p>
        </div>
        
        <button onclick="closeSuccessModal()" class="w-full py-3 px-6 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition">
            Continue to Dashboard
        </button>
    </div>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
let selectedPlanName = '';
let selectedAmount = 0;
let currentOrderId = '';

function subscribeToPlan(plan, amount) {
    selectedPlanName = plan;
    selectedAmount = amount / 100; // Convert paise to rupees for display
    
    document.getElementById('selectedPlanName').textContent = plan.charAt(0).toUpperCase() + plan.slice(1);
    document.getElementById('selectedAmount').textContent = selectedAmount;
    document.getElementById('paymentModal').style.display = 'flex';
    
    // Note: Payment is handled by Razorpay buttons in the modal
}

function downgradePlan(plan) {
    if (confirm('Are you sure you want to downgrade to the free plan? You will lose access to premium features.')) {
        fetch('/user/subscribe', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({plan: plan})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        });
    }
}

function closePaymentModal() {
    document.getElementById('paymentModal').style.display = 'none';
}

function closeSuccessModal() {
    document.getElementById('successModal').style.display = 'none';
    window.location.href = '/dashboard';
}

// Razorpay payment handler
document.getElementById('razorpayButton').addEventListener('click', function() {
    // Create order first
    fetch('/razorpay/create-order', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({plan: selectedPlanName})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentOrderId = data.order_id;
            
            const options = {
                "key": data.key,
                "amount": data.amount,
                "currency": data.currency,
                "name": "PharmaDocs AI",
                "description": `${selectedPlanName.charAt(0).toUpperCase() + selectedPlanName.slice(1)} Plan Subscription`,
                "order_id": data.order_id,
                "handler": function (response) {
                    // Verify payment
                    verifyPayment(response);
                },
                "prefill": {
                    "name": "{{ user.name }}",
                    "email": "{{ user.email }}"
                },
                "theme": {
                    "color": "#3B82F6"
                },
                "modal": {
                    "ondismiss": function() {
                        console.log('Payment modal closed');
                    }
                }
            };
            
            const rzp = new Razorpay(options);
            rzp.open();
        } else {
            if (data.setup_required) {
                alert('Setup Required: ' + data.message);
                document.getElementById('payment-result').innerHTML = 
                    '<div class="bg-yellow-50 border border-yellow-200 rounded p-3 mt-2">' +
                    '<p class="text-yellow-800 text-sm"><strong>Setup Required:</strong> ' + data.message + '</p>' +
                    '</div>';
                document.getElementById('payment-result').classList.remove('hidden');
            } else {
                alert('Error creating order: ' + data.error);
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating order');
    });
});

// Payment link handler
document.getElementById('paymentLinkButton').addEventListener('click', function() {
    fetch('/razorpay/payment-link', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({plan: selectedPlanName})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.open(data.payment_link, '_blank');
            document.getElementById('payment-result').innerHTML = 
                '<p class="text-green-600">Payment link opened in new tab. Complete payment there.</p>';
            document.getElementById('payment-result').classList.remove('hidden');
        } else {
            alert('Error creating payment link: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating payment link');
    });
});

function verifyPayment(response) {
    fetch('/razorpay/verify-payment', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(response)
    })
    .then(response => response.json())
    .then(data => {
        closePaymentModal();
        
        if (data.success) {
            document.getElementById('successModal').style.display = 'flex';
        } else {
            alert('Payment verification failed: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Payment verification failed');
    });
}
</script>
{% endblock %}