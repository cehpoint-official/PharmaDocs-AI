{% extends "base.html" %}

{% block title %}Protocol Generator - PharmaDocs AI Platform{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-10">

    <!-- Header Section -->
    <div class="mb-10 flex flex-col md:flex-row md:items-center justify-between gap-6">
        <div>
            <div class="flex items-center gap-2 text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">
                <span class="text-indigo-600">Verification Intelligence</span>
            </div>
            <h1 class="text-3xl font-display font-black text-slate-900 tracking-tight">Analytical Protocol Generator
            </h1>
            <p class="text-sm font-medium text-slate-500 mt-2 max-w-2xl leading-relaxed">
                Automate the authorship of Analytical Method Verification protocols. Select your methodology, ingest the
                source document, and let our AI structure the validation framework.
            </p>
        </div>

        <div>
            <button type="button" onclick="fillProtocolGeneratorDemo()"
                class="btn-secondary-saas px-6 py-2.5 shadow-soft border-amber-200 text-amber-700 hover:bg-amber-50">
                <i class="fas fa-magic mr-2"></i> Sequence Prototype
            </button>
        </div>
    </div>

    <div class="space-y-12">

        <!-- Step 1: Methodology Selection -->
        <section class="card-premium p-8">
            <div class="flex items-center justify-between mb-8">
                <div class="flex items-center gap-3">
                    <div
                        class="w-8 h-8 bg-indigo-50 text-indigo-600 rounded-lg flex items-center justify-center text-xs border border-indigo-100">
                        01</div>
                    <h2 class="text-xs font-black text-slate-900 uppercase tracking-widest">Select Analytical
                        Methodology</h2>
                </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4" id="method-buttons">
                <!-- Dynamically Injected Methods -->
            </div>
        </section>

        <!-- Step 2: Document Ingestion -->
        <section class="card-premium p-8 transition-all duration-500 hidden" id="upload-section">
            <div class="flex items-center gap-3 mb-8">
                <div
                    class="w-8 h-8 bg-blue-50 text-blue-600 rounded-lg flex items-center justify-center text-xs border border-blue-100">
                    02</div>
                <h2 class="text-xs font-black text-slate-900 uppercase tracking-widest">Ingest Source Methodology (PDF)
                </h2>
            </div>

            <div class="relative group">
                <div
                    class="w-full min-h-[180px] bg-slate-50/50 border-2 border-dashed border-slate-200 rounded-[2rem] flex flex-col items-center justify-center p-8 transition-all hover:border-indigo-300 hover:bg-slate-50">
                    <div
                        class="w-14 h-14 bg-white border border-slate-100 rounded-2xl flex items-center justify-center text-indigo-600 shadow-soft group-hover:scale-110 group-hover:rotate-3 transition-transform mb-4">
                        <i class="fas fa-file-upload text-xl"></i>
                    </div>
                    <div class="text-center">
                        <p class="text-sm font-black text-slate-900 leading-tight">Drop methodology PDF or <span
                                class="text-indigo-600 hover:underline cursor-pointer">browse</span></p>
                        <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mt-2">Maximum file size:
                            50MB</p>
                    </div>
                    <input type="file" accept=".pdf" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                        id="file-upload">
                </div>

                <div class="mt-4 flex items-center justify-center text-emerald-600 hidden gap-2 animate-in fade-in slide-in-from-top-2"
                    id="file-uploaded">
                    <i class="fas fa-check-circle text-sm"></i>
                    <span id="file-name" class="text-[10px] font-black uppercase tracking-widest"></span>
                </div>
            </div>
        </section>

        <!-- Step 3: Intelligence Output Preview -->
        <section class="card-premium overflow-hidden hidden" id="extracted-data-section">
            <div class="px-8 py-5 border-b border-slate-100 bg-emerald-50/30 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div
                        class="w-8 h-8 bg-emerald-100 text-emerald-600 rounded-lg flex items-center justify-center text-xs shadow-soft border border-emerald-200">
                        03</div>
                    <h2 class="text-xs font-black text-slate-900 uppercase tracking-widest">AI Extraction Preview</h2>
                </div>
                <i class="fas fa-brain text-emerald-600 text-xs"></i>
            </div>
            <div class="p-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8" id="extracted-data-grid">
                <!-- Extracted Keys -->
            </div>
        </section>

        <!-- Step 4: Verification Matrix -->
        <section class="card-premium overflow-hidden hidden" id="parameters-section">
            <div class="px-8 py-5 border-b border-slate-100 bg-amber-50/30 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div
                        class="w-8 h-8 bg-amber-100 text-amber-600 rounded-lg flex items-center justify-center text-xs shadow-soft border border-amber-200">
                        04</div>
                    <h2 class="text-xs font-black text-slate-900 uppercase tracking-widest">Auto-Selected Verification
                        Parameters</h2>
                </div>
            </div>
            <div class="p-8 flex flex-wrap gap-3" id="parameters-list">
                <!-- Parameter Bubbles -->
            </div>
        </section>

        <!-- Execution Hub -->
        <div class="hidden pt-6" id="generate-section">
            <button id="generate-btn"
                class="w-full btn-primary-saas py-6 text-xs shadow-2xl shadow-indigo-200 flex items-center justify-center gap-3">
                <i class="fas fa-wand-magic-sparkles"></i>
                Synthesize Detailed Analytical Protocol
            </button>
        </div>

        <!-- Final Protocol Output -->
        <section class="card-premium overflow-hidden hidden" id="protocol-preview">
            <div class="px-8 py-6 border-b border-slate-100 bg-slate-900 flex items-center justify-between">
                <h2 class="text-[10px] font-black text-white uppercase tracking-[0.2em]">Generated Protocol Manifest
                </h2>
                <button id="download-btn"
                    class="px-6 py-2.5 bg-emerald-600 text-white rounded-xl font-black text-[9px] uppercase tracking-widest hover:bg-emerald-700 transition-all shadow-lg flex items-center gap-2">
                    <i class="fas fa-download"></i>
                    Retrive Manifest (.docx)
                </button>
            </div>
            <div class="p-10 bg-slate-50 max-h-[600px] overflow-y-auto custom-scrollbar" id="protocol-content">
                <!-- Dynamic Content -->
            </div>
        </section>

    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentState = { selectedMethod: '', uploadedFile: null, extractedData: null, selectedParams: [], generatedProtocol: null };

    async function initializeMethods() {
        const response = await fetch('/amv/protocol/api/methods');
        const methods = await response.json();
        const container = document.getElementById('method-buttons');
        container.innerHTML = methods.map(method => `
            <button onclick="selectMethod('${method.value}')" class="p-6 rounded-2xl border-2 border-slate-100 bg-white transition-all group method-btn relative overflow-hidden flex flex-col items-center gap-4 hover:border-indigo-200" id="method-${method.value}">
                <span class="text-3xl filter grayscale group-hover:grayscale-0 transition-all duration-500">${getMethodIcon(method.value)}</span>
                <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest text-center group-hover:text-indigo-600 transition-colors">${method.label}</span>
                <div class="absolute top-2 right-2 opacity-0 group-[.selected]:opacity-100 transition-opacity">
                   <i class="fas fa-check-circle text-indigo-600 text-xs"></i>
                </div>
                <div class="absolute inset-x-0 bottom-0 h-1 bg-indigo-600 translate-y-1 group-[.selected]:translate-y-0 transition-transform"></div>
            </button>
        `).join('');
    }

    function getMethodIcon(method) {
        const icons = { 'uv': 'ðŸ“Š', 'aas': 'âš›ï¸', 'hplc': 'ðŸ§ª', 'uplc': 'ðŸ’§', 'gc': 'ðŸŒ¡ï¸', 'titration': 'âš—ï¸' };
        return icons[method] || 'ðŸ”¬';
    }

    async function selectMethod(method) {
        currentState.selectedMethod = method;
        document.querySelectorAll('.method-btn').forEach(btn => btn.classList.remove('selected', 'border-indigo-600', 'bg-indigo-50/30', 'shadow-soft'));
        const selectedBtn = document.getElementById(`method-${method}`);
        selectedBtn.classList.add('selected', 'border-indigo-600', 'bg-indigo-50/30', 'shadow-soft');

        const uploadSection = document.getElementById('upload-section');
        uploadSection.classList.remove('hidden');
        uploadSection.scrollIntoView({ behavior: 'smooth', block: 'center' });

        try {
            const response = await fetch(`/amv/protocol/api/parameters/${method}`);
            currentState.selectedParams = await response.json();
        } catch (e) { console.error(e); }
    }

    document.getElementById('file-upload').addEventListener('change', async function (e) {
        const file = e.target.files[0];
        if (file && file.type === 'application/pdf') {
            currentState.uploadedFile = file;
            document.getElementById('file-name').textContent = file.name;
            document.getElementById('file-uploaded').classList.remove('hidden');
            await simulateDataExtraction();
        } else { alert('GQP Restriction: Please upload a valid PDF method document.'); }
    });

    async function simulateDataExtraction() {
        const response = await fetch('/amv/protocol/api/extract_data', { method: 'POST' });
        currentState.extractedData = await response.json();
        showExtractedData();
        showParameters();
        showGenerateButton();
    }

    function showExtractedData() {
        const section = document.getElementById('extracted-data-section');
        const grid = document.getElementById('extracted-data-grid');
        const d = currentState.extractedData;
        const fields = [
            ['Product Identity', d.productName, 'indigo'],
            ['Concentration', d.concentration, 'blue'],
            ['Protocol Code', d.protocolNumber, 'purple'],
            ['Methodology', d.methodology, 'emerald'],
            ['Target Wavelength', d.wavelength, 'amber'],
            ['Primary Acceptance', d.acceptanceCriteria, 'rose']
        ];
        grid.innerHTML = fields.map(([label, val, color]) => `
           <div class="space-y-1 group">
              <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest group-hover:text-indigo-600 transition-colors">${label}</p>
              <p class="text-sm font-black text-slate-900 leading-tight">${val}</p>
           </div>
        `).join('');
        section.classList.remove('hidden');
        section.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function showParameters() {
        const section = document.getElementById('parameters-section');
        const list = document.getElementById('parameters-list');
        list.innerHTML = currentState.selectedParams.map(param => `
            <div class="bg-white px-5 py-2.5 rounded-xl border border-amber-100 flex items-center shadow-soft group hover:border-amber-300 transition-all">
                <i class="fas fa-check-double text-[10px] text-amber-500 mr-3"></i>
                <span class="text-[10px] font-black text-slate-600 uppercase tracking-widest">${param}</span>
            </div>
        `).join('');
        section.classList.remove('hidden');
    }

    function showGenerateButton() {
        document.getElementById('generate-section').classList.remove('hidden');
        document.getElementById('generate-section').scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    document.getElementById('generate-btn').addEventListener('click', async function () {
        const btn = this;
        const originalContent = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-3"></i> Intelligence Engines Polishing Protocol...`;

        try {
            const response = await fetch('/amv/protocol/api/generate_protocol', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    extractedData: currentState.extractedData,
                    selectedParams: currentState.selectedParams,
                    selectedMethod: currentState.selectedMethod
                })
            });
            const result = await response.json();
            currentState.generatedProtocol = result.protocol;
            showProtocolPreview();
        } catch (e) {
            console.error(e);
            alert('Synthesis failed. Please verify source document integrity.');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalContent;
        }
    });

    function showProtocolPreview() {
        const section = document.getElementById('protocol-preview');
        const content = document.getElementById('protocol-content');
        const p = currentState.generatedProtocol;
        content.innerHTML = `
            <div class="card-premium p-8 space-y-10 bg-white">
               <div class="border-b border-slate-100 pb-8 text-center">
                  <h3 class="text-2xl font-display font-black text-slate-900 tracking-tight mb-2">${p.header.title}</h3>
                  <div class="flex justify-center gap-6 text-[10px] font-black text-slate-400 uppercase tracking-widest">
                     <span>Code: ${p.header.protocolNumber}</span>
                     <span>|</span>
                     <span>Revision: ${p.header.effectiveDate}</span>
                  </div>
               </div>
               
               <div class="space-y-4">
                  <h4 class="text-xs font-black text-slate-900 uppercase tracking-widest flex items-center gap-3">
                     <i class="fas fa-bullseye text-indigo-600"></i>
                     Functional Objective
                  </h4>
                  <p class="text-sm font-medium text-slate-600 leading-relaxed pl-7">${p.objective.split('\n').slice(0, 4).join('<br>')}</p>
               </div>

               <div class="space-y-6">
                  <h4 class="text-xs font-black text-slate-900 uppercase tracking-widest flex items-center gap-3">
                     <i class="fas fa-list-check text-emerald-600"></i>
                     Verification Matrix Inclusion
                  </h4>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pl-7">
                     ${Object.keys(p.parameters).map(param => `
                        <div class="flex items-center gap-3 text-xs font-bold text-slate-700">
                           <i class="fas fa-circle-check text-emerald-400 text-[10px]"></i>
                           ${param}
                        </div>
                     `).join('')}
                  </div>
               </div>

               <div class="p-6 bg-emerald-50/50 border border-emerald-100 rounded-2xl flex items-center gap-6">
                  <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center text-emerald-500 shadow-soft shrink-0">
                     <i class="fas fa-file-shield text-xl"></i>
                  </div>
                  <div>
                     <p class="text-xs font-black text-slate-900 uppercase tracking-widest">System Ready</p>
                     <p class="text-[11px] font-medium text-slate-600">Protocol synthesized with full GxP parameter mapping.</p>
                  </div>
               </div>
            </div>
        `;
        section.classList.remove('hidden');
        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    document.getElementById('download-btn').addEventListener('click', async function () {
        const response = await fetch('/amv/protocol/api/download_protocol', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ protocol: currentState.generatedProtocol })
        });
        if (!response.ok) { alert('Download encryption failed'); return; }
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `AMV_Protocol_${currentState.extractedData.productName.replace(/\s+/g, '_')}.docx`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    });

    async function fillProtocolGeneratorDemo() {
        await selectMethod('hplc');
        const response = await fetch('/amv/protocol/api/extract_data', { method: 'POST' });
        currentState.extractedData = await response.json();
        showExtractedData();
        showParameters();
        showGenerateButton();
    }

    document.addEventListener('DOMContentLoaded', () => { initializeMethods(); });
</script>

<style>
    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #e2e8f0;
        border-radius: 10px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #cbd5e1;
    }
</style>
{% endblock %}