{% extends "base.html" %}
{% block title %}Workspace Management - PharmaDocs AI Platform{% endblock %}

{% block content %}
<div class="max-w-full mx-auto px-4 py-6">

  <!-- Compact Header -->
  <div class="mb-4 flex flex-col md:flex-row md:items-center justify-between gap-4 border-b pb-4">
    <div>
      <div class="flex items-center gap-1 text-[10px] font-bold text-gray-400 uppercase mb-1">
        <a href="{{ url_for('dashboard.user_dashboard') }}" class="hover:text-blue-700">APP</a>
        <i class="fas fa-chevron-right text-[7px]"></i>
        <span class="text-blue-700">Workspace Entities</span>
      </div>
      <h1 class="text-xl font-bold text-gray-900 leading-none">Organization Profile & Metadata</h1>
    </div>

    <div class="flex items-center gap-2">
      <button onclick="openModal('addCompanyModal')"
        class="px-3 py-1.5 bg-blue-700 text-white rounded text-[10px] font-bold uppercase hover:bg-blue-800 transition-all">
        <i class="fas fa-plus mr-1"></i> REGISTER ENTITY
      </button>
    </div>
  </div>

  {% if companies %}
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    {% for company in companies %}
    <div class="bg-white border rounded shadow-sm overflow-hidden flex flex-col">
      <!-- Entity Identity -->
      <div class="px-3 py-2 bg-gray-50 border-b flex items-center justify-between">
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 rounded border bg-white flex items-center justify-center overflow-hidden">
            {% if company.logo_url %}
            <img src="{{ company.logo_url }}" class="w-6 h-6 object-contain">
            {% else %}
            <i class="fas fa-building text-gray-300 text-xs"></i>
            {% endif %}
          </div>
          <div>
            <h4 class="text-sm font-bold text-gray-900 leading-tight">{{ company.name }}</h4>
            <p class="text-[9px] text-gray-400 font-bold uppercase">ID: ENT-{{ company.id }}</p>
          </div>
        </div>
        <div class="flex items-center gap-1">
          <button
            onclick="editCompany('{{ company.id }}', '{{ company.name }}', '{{ company.address }}', '{{ company.contact_info }}')"
            class="p-1.5 text-blue-600 hover:bg-blue-50 rounded transition-all">
            <i class="fas fa-edit text-[10px]"></i>
          </button>
          <button onclick="deleteCompany('{{ company.id }}', '{{ company.name }}')"
            class="p-1.5 text-red-600 hover:bg-red-50 rounded transition-all">
            <i class="fas fa-trash-alt text-[10px]"></i>
          </button>
        </div>
      </div>

      <div class="p-3 grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Data Cluster 1: Logistics -->
        <div class="space-y-2">
          <div class="flex items-start gap-2">
            <i class="fas fa-map-marker-alt text-gray-300 text-[10px] mt-0.5"></i>
            <div>
              <p class="text-[9px] font-black text-gray-400 uppercase leading-none">Registered Address</p>
              <p class="text-[11px] font-bold text-gray-600 mt-1">{{ company.address or 'UNSET' }}</p>
            </div>
          </div>
          <div class="flex items-start gap-2">
            <i class="fas fa-address-book text-gray-300 text-[10px] mt-0.5"></i>
            <div>
              <p class="text-[9px] font-black text-gray-400 uppercase leading-none">Support Contact</p>
              <p class="text-[11px] font-bold text-gray-600 mt-1">{{ company.contact_info or 'UNSET' }}</p>
            </div>
          </div>
        </div>

        <!-- Data Cluster 2: Resource Matrix -->
        <div class="bg-gray-50 border rounded p-2 flex flex-col justify-center">
          <p class="text-[9px] font-black text-gray-400 uppercase mb-2 px-1">Resource Index</p>
          <div class="grid grid-cols-3 gap-2 text-center">
            <div class="border-r last:border-0 pr-2">
              <p class="text-xs font-bold text-blue-700">{{ company.equipment_count or 0 }}</p>
              <p class="text-[8px] font-bold text-gray-400 uppercase">Equip</p>
            </div>
            <div class="border-r last:border-0 px-2">
              <p class="text-xs font-bold text-emerald-600">{{ company.reagent_count or 0 }}</p>
              <p class="text-[8px] font-bold text-gray-400 uppercase">Reag</p>
            </div>
            <div class="pl-2">
              <p class="text-xs font-bold text-purple-600">{{ company.material_count or 0 }}</p>
              <p class="text-[8px] font-bold text-gray-400 uppercase">Mat</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Sub-brands Integration -->
      <div class="px-3 py-2 bg-gray-50/50 border-t">
        <div class="flex items-center justify-between mb-2">
          <h5 class="text-[10px] font-black text-gray-500 uppercase">Registered Sub-brands</h5>
          <button onclick="addBrand('{{ company.id }}')" class="text-[9px] font-bold text-blue-700 hover:underline">+
            ADD BRAND</button>
        </div>
        <div class="flex flex-wrap gap-2">
          {% if company.brands %}
          {% for brand in company.brands %}
          <span
            class="inline-flex items-center gap-1 px-2 py-0.5 bg-white border border-gray-200 rounded text-[10px] font-bold text-gray-600">
            <i class="fas fa-tag text-[8px] text-gray-300"></i> {{ brand.name }}
          </span>
          {% endfor %}
          {% else %}
          <span class="text-[9px] italic text-gray-400">No subsidiary brands linked.</span>
          {% endif %}
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="px-3 py-2 border-t flex gap-2">
        <button onclick="addEquipment('{{ company.id }}')"
          class="flex-1 py-1 bg-gray-100 border text-gray-600 rounded text-[9px] font-bold uppercase transition-all hover:bg-white">+
          EQUIP</button>
        <button onclick="addReagent('{{ company.id }}')"
          class="flex-1 py-1 bg-gray-100 border text-gray-600 rounded text-[9px] font-bold uppercase transition-all hover:bg-white">+
          REAG</button>
        <button onclick="addMaterial('{{ company.id }}')"
          class="flex-1 py-1 bg-gray-100 border text-gray-600 rounded text-[9px] font-bold uppercase transition-all hover:bg-white">+
          MAT</button>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="py-16 text-center bg-white rounded border border-dashed border-gray-300">
    <div class="w-12 h-12 bg-gray-50 text-gray-200 rounded-full flex items-center justify-center mx-auto mb-4 border">
      <i class="fas fa-building text-xl"></i>
    </div>
    <h3 class="text-sm font-bold text-gray-900">No Registered Workspace Entities</h3>
    <p class="text-gray-500 text-xs mt-1 mb-8">Initialize your organization profile to begin document generation.</p>
    <button onclick="openModal('addCompanyModal')"
      class="px-6 py-2 bg-blue-700 text-white rounded text-[10px] font-bold uppercase hover:bg-blue-800 transition-all">
      REGISTER FIRST ENTITY
    </button>
  </div>
  {% endif %}
</div>

<!-- Modals System -->

<!-- Register Company Modal -->
<div id="addCompanyModal" class="modal-backdrop hidden transition-opacity duration-300">
  <div class="modal-content-saas max-w-xl">
    <div class="flex justify-between items-center p-8 border-b border-slate-50">
      <div>
        <h3 class="text-xl font-display font-black text-slate-900">Register Entity</h3>
        <p class="text-xs text-slate-500 mt-1 uppercase tracking-widest font-bold">New Global Company Identity</p>
      </div>
      <div class="flex items-center gap-3">
        <button type="button" onclick="fillCompanyDemo()"
          class="w-10 h-10 bg-amber-50 text-amber-600 rounded-xl flex items-center justify-center border border-amber-100 hover:bg-amber-100 transition-colors">
          <i class="fas fa-magic text-sm"></i>
        </button>
        <button onclick="closeModal('addCompanyModal')"
          class="w-10 h-10 bg-slate-50 text-slate-400 rounded-xl hover:bg-red-50 hover:text-red-500 flex items-center justify-center transition-colors">
          <i class="fas fa-times text-xs"></i>
        </button>
      </div>
    </div>
    <form id="addCompanyForm" class="p-8 space-y-6" enctype="multipart/form-data">
      <div class="space-y-1.5">
        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Company Primary Name <span
            class="text-red-500">*</span></label>
        <input type="text" id="companyName" name="name" required class="input-saas py-3 px-4"
          placeholder="e.g. Acme Pharmaceutical Ltd.">
      </div>
      <div class="space-y-1.5">
        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Headquarters Address</label>
        <textarea id="companyAddress" name="address" class="input-saas py-3 px-4 min-h-[100px]"
          placeholder="Full street address, city, and state..."></textarea>
      </div>
      <div class="space-y-1.5">
        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Visual Identity
          (Logo)</label>
        <div
          class="border-2 border-dashed border-slate-100 rounded-2xl p-6 text-center bg-slate-50/50 hover:bg-indigo-50/30 hover:border-indigo-100 transition-all cursor-pointer relative group">
          <i
            class="fas fa-cloud-arrow-up text-slate-300 text-2xl group-hover:text-indigo-400 group-hover:scale-110 transition-all mb-2 block"></i>
          <p class="text-[10px] font-bold text-slate-500 uppercase">Click to select branding asset</p>
          <input type="file" id="companyLogo" name="logo" accept="image/*"
            class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
        </div>
      </div>
      <div class="pt-6 border-t border-slate-50 flex gap-4">
        <button type="button" onclick="closeModal('addCompanyModal')"
          class="flex-1 btn-secondary-saas py-3">Cancel</button>
        <button type="submit" class="flex-[2] btn-primary-saas py-3 flex items-center justify-center gap-3">
          <i class="fas fa-save"></i> Establish Identity
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Company Modal -->
<div id="editCompanyModal" class="modal-backdrop hidden transition-opacity duration-300">
  <div class="modal-content-saas max-w-xl">
    <div class="flex justify-between items-center p-8 border-b border-slate-50">
      <div>
        <h3 class="text-xl font-display font-black text-slate-900">Manage Identity</h3>
        <p class="text-xs text-slate-500 mt-1 uppercase tracking-widest font-bold">Update Global Configuration</p>
      </div>
      <button onclick="closeModal('editCompanyModal')"
        class="w-10 h-10 bg-slate-50 text-slate-400 rounded-xl hover:bg-red-50 hover:text-red-500 flex items-center justify-center transition-colors">
        <i class="fas fa-times text-xs"></i>
      </button>
    </div>
    <form id="editCompanyForm" class="p-8 space-y-6" enctype="multipart/form-data">
      <input type="hidden" id="editCompanyId" name="company_id">
      <div class="space-y-1.5">
        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Company Name <span
            class="text-red-500">*</span></label>
        <input type="text" id="editCompanyName" name="name" required class="input-saas py-3 px-4">
      </div>
      <div class="space-y-1.5">
        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Address</label>
        <textarea id="editCompanyAddress" name="address" class="input-saas py-3 px-4 min-h-[100px]"></textarea>
      </div>
      <div class="space-y-1.5">
        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Glass Materials Definition
          (JSON Object)</label>
        <textarea id="editCompanyGlassMaterials" name="glass_materials"
          class="input-saas py-3 px-4 min-h-[80px] font-mono text-[10px]"
          placeholder='{ "type": "BoroSilicate", "grade": "USP Type I" }'></textarea>
      </div>
      <div class="pt-6 border-t border-slate-50 flex gap-4">
        <button type="button" onclick="closeModal('editCompanyModal')"
          class="flex-1 btn-secondary-saas py-3">Discard</button>
        <button type="submit" class="flex-[2] btn-primary-saas py-3">Save Workspace Policy</button>
      </div>
    </form>
  </div>
</div>

<!-- Sub-brand Appending -->
<div id="addSubBrandModal" class="modal-backdrop hidden transition-opacity duration-300">
  <div class="modal-content-saas max-w-md">
    <div class="flex justify-between items-center p-6 border-b border-slate-50">
      <h3 class="text-lg font-display font-black text-slate-900">Append Sub-brand</h3>
      <button onclick="closeModal('addSubBrandModal')" class="text-slate-400 hover:text-slate-600">
        <i class="fas fa-times text-xs"></i>
      </button>
    </div>
    <form id="addSubBrandForm" class="p-6 space-y-6">
      <input type="hidden" id="subBrandCompanyId" name="company_id">
      <div class="space-y-1.5">
        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Brand Designation <span
            class="text-red-500">*</span></label>
        <input type="text" name="name" required class="input-saas py-3 px-4" placeholder="e.g. Quality Division">
      </div>
      <button type="submit" class="w-full btn-primary-saas py-3">Link Brand Hierarchy</button>
    </form>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  // Preservation of existing logic with UI state enhancements

  function toggleRelDropdown(btn) {
    const container = btn.closest('.dropdown-container');
    const menu = container.querySelector('.custom-dropdown');

    // Close all others
    document.querySelectorAll('.custom-dropdown').forEach(d => {
      if (d !== menu) d.classList.add('hidden');
    });

    menu.classList.toggle('hidden');
  }

  // Close dropdowns on outside click
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.dropdown-container')) {
      document.querySelectorAll('.custom-dropdown').forEach(d => d.classList.add('hidden'));
    }
  });

  async function editCompany(id) {
    try {
      const res = await fetch(`/company/get/${id}`);
      const result = await res.json();
      if (!result.success) return alert('Policy Retrieval Failed');

      const c = result.company;
      document.getElementById('editCompanyId').value = c.id;
      document.getElementById('editCompanyName').value = c.name;
      document.getElementById('editCompanyAddress').value = c.address || '';
      document.getElementById('editCompanyGlassMaterials').value = c.glass_materials ? JSON.stringify(c.glass_materials, null, 2) : '';
      openModal('editCompanyModal');
    } catch (err) { console.error(err); }
  }

  document.getElementById('addCompanyForm').addEventListener('submit', async function (e) {
    e.preventDefault();
    const btn = this.querySelector('button[type="submit"]');
    const original = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> Initializing Workspace...`;

    try {
      const res = await fetch('/company/create', { method: 'POST', body: new FormData(this) });
      const r = await res.json();
      if (r.success) location.reload();
      else alert('GXP Restriction: ' + (r.error || 'Identity generation failed'));
    } catch (err) { alert('System Exception'); }
    finally { btn.disabled = false; btn.innerHTML = original; }
  });

  document.getElementById('editCompanyForm').addEventListener('submit', async function (e) {
    e.preventDefault();
    const btn = this.querySelector('button[type="submit"]');
    btn.disabled = true;
    btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> Committing Policy...`;

    try {
      const id = document.getElementById('editCompanyId').value;
      const res = await fetch(`/company/update/${id}`, { method: 'POST', body: new FormData(this) });
      const r = await res.json();
      if (r.success) location.reload();
      else alert('Error: ' + r.error);
    } catch (err) { alert('Commit Failed'); }
    finally { btn.disabled = false; btn.innerHTML = 'Save Workspace Policy'; }
  });

  function addSubBrand(id) {
    document.getElementById('subBrandCompanyId').value = id;
    document.getElementById('addSubBrandForm').reset();
    openModal('addSubBrandModal');
  }

  document.getElementById('addSubBrandForm').addEventListener('submit', async function (e) {
    e.preventDefault();
    const btn = this.querySelector('button[type="submit"]');
    btn.disabled = true;
    btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> Linking...`;

    try {
      const res = await fetch('/subbrand/create', { method: 'POST', body: new FormData(this) });
      const r = await res.json();
      if (r.success) location.reload();
      else alert('Linking Error: ' + r.error);
    } catch (err) { alert('Network Fault'); }
    finally { btn.disabled = false; btn.innerHTML = 'Link Brand Hierarchy'; }
  });

  function fillCompanyDemo() {
    document.getElementById('companyName').value = 'Ind-Swift Laboratories Ltd.';
    document.getElementById('companyAddress').value = 'S.C.O. 850, Shivalik Enclave, NAC Manimajra, Chandigarh - 160101';
    document.getElementById('companyName').classList.add('bg-indigo-50/50');
    setTimeout(() => document.getElementById('companyName').classList.remove('bg-indigo-50/50'), 1000);
  }

  // Simplified modal helpers (base.html usually has openModal/closeModal but we ensure compatibility)
  if (typeof openModal === 'undefined') {
    window.openModal = id => {
      const m = document.getElementById(id);
      m.classList.remove('hidden');
      m.classList.add('flex');
      setTimeout(() => m.classList.add('opacity-100'), 10);
    };
    window.closeModal = id => {
      const m = document.getElementById(id);
      m.classList.remove('opacity-100');
      setTimeout(() => {
        m.classList.add('hidden');
        m.classList.remove('flex');
      }, 300);
    };
  }
</script>

<style>
  .custom-dropdown {
    transform-origin: top right;
  }
</style>
{% endblock %}