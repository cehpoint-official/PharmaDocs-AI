{% extends "base.html" %}
{% block title %}Workspace Management - PharmaDocs AI Platform{% endblock %}

{% block content %}
<div class="max-w-full mx-auto px-4 py-6">

  <!-- Compact Header -->
  <div class="mb-4 flex flex-col md:flex-row md:items-center justify-between gap-4 border-b pb-4">
    <div>
      <div class="flex items-center gap-1 text-[10px] font-bold text-gray-400 uppercase mb-1">
        <a href="{{ url_for('dashboard.user_dashboard') }}" class="hover:text-blue-700">APP</a>
        <i class="fas fa-chevron-right text-[7px]"></i>
        <span class="text-blue-700">Workspace Entities</span>
      </div>
      <h1 class="text-xl font-bold text-gray-900 leading-none">Organization Profile & Metadata</h1>
    </div>

    <div class="flex items-center gap-2">
      <button onclick="openModal('addCompanyModal')"
        class="px-3 py-1.5 bg-[#1e40af] text-white rounded text-[10px] font-bold uppercase hover:bg-blue-800 transition-all shadow-lg shadow-indigo-100">
        <i class="fas fa-plus mr-1"></i> REGISTER ENTITY
      </button>
    </div>
  </div>

  {% if companies %}
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    {% for company in companies %}
    <div
      class="bg-white rounded-[1.5rem] border border-slate-100 shadow-xl shadow-slate-200/50 transition-all duration-300 overflow-hidden flex flex-col">
      <!-- Entity Identity -->
      <div class="px-6 py-4 bg-slate-50/50 border-b border-slate-100 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div
            class="w-10 h-10 rounded-xl border border-indigo-100 bg-white flex items-center justify-center overflow-hidden shadow-soft">
            {% if company.logo_url %}
            <img src="{{ company.logo_url }}" class="w-8 h-8 object-contain">
            {% else %}
            <i class="fas fa-building text-indigo-300 text-sm"></i>
            {% endif %}
          </div>
          <div>
            <h4 class="text-sm font-black text-slate-900 leading-tight">{{ company.name }}</h4>
            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">ID: ENT-{{ company.id }}</p>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <button
            onclick="editCompany('{{ company.id }}', '{{ company.name }}', '{{ company.address }}', '{{ company.contact_info }}')"
            class="p-2 text-indigo-600 hover:bg-indigo-50 rounded-lg transition-all" title="Edit Identity">
            <i class="fas fa-edit text-xs"></i>
          </button>
          <button onclick="deleteCompany('{{ company.id }}', '{{ company.name }}')"
            class="p-2 text-rose-500 hover:bg-rose-50 rounded-lg transition-all" title="Terminate Protocol">
            <i class="fas fa-trash-alt text-xs"></i>
          </button>
        </div>
      </div>

      <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Data Cluster 1: Logistics -->
        <div class="space-y-4">
          <div class="flex items-start gap-3">
            <div
              class="w-8 h-8 bg-slate-50 text-slate-400 rounded-lg flex items-center justify-center border border-slate-100 flex-shrink-0">
              <i class="fas fa-map-marker-alt text-[10px]"></i>
            </div>
            <div>
              <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest leading-none">Registered Address
              </p>
              <p class="text-xs font-bold text-slate-600 mt-1 leading-relaxed">{{ company.address or 'UNSET' }}</p>
            </div>
          </div>
          <div class="flex items-start gap-3">
            <div
              class="w-8 h-8 bg-slate-50 text-slate-400 rounded-lg flex items-center justify-center border border-slate-100 flex-shrink-0">
              <i class="fas fa-address-book text-[10px]"></i>
            </div>
            <div>
              <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest leading-none">Support Contact</p>
              <p class="text-xs font-bold text-slate-600 mt-1 leading-relaxed">{{ company.contact_info or 'UNSET' }}</p>
            </div>
          </div>
        </div>

        <!-- Data Cluster 2: Resource Matrix -->
        <div class="bg-indigo-50/30 border border-indigo-100/50 rounded-2xl p-4 flex flex-col justify-center">
          <p class="text-[9px] font-black text-indigo-400 uppercase tracking-widest mb-3 px-1">Resource Index</p>
          <div class="grid grid-cols-3 gap-3 text-center">
            <div class="border-r border-indigo-100 last:border-0 pr-3">
              <p class="text-lg font-display font-black text-indigo-700 leading-none mb-1">{{ company.equipment_count or
                0 }}</p>
              <p class="text-[8px] font-black text-slate-400 uppercase tracking-tighter">Equip</p>
            </div>
            <div class="border-r border-indigo-100 last:border-0 px-3">
              <p class="text-lg font-display font-black text-emerald-600 leading-none mb-1">{{ company.reagent_count or
                0 }}</p>
              <p class="text-[8px] font-black text-slate-400 uppercase tracking-tighter">Reag</p>
            </div>
            <div class="pl-3">
              <p class="text-lg font-display font-black text-purple-600 leading-none mb-1">{{ company.material_count or
                0 }}</p>
              <p class="text-[8px] font-black text-slate-400 uppercase tracking-tighter">Mat</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Sub-brands Integration -->
      <div class="px-6 py-4 bg-slate-50/50 border-t border-slate-100">
        <div class="flex items-center justify-between mb-3">
          <h5 class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Registered Sub-brands</h5>
          <button onclick="addSubBrand('{{ company.id }}')"
            class="text-[9px] font-black text-indigo-600 hover:text-indigo-800 transition-colors uppercase tracking-widest">+
            ADD BRAND</button>
        </div>
        <div class="flex flex-wrap gap-2">
          {% if company.brands %}
          {% for brand in company.brands %}
          <span
            class="inline-flex items-center gap-2 px-3 py-1 bg-white border border-slate-100 rounded-lg text-[10px] font-bold text-slate-600 shadow-sm">
            <i class="fas fa-tag text-[8px] text-indigo-300"></i> {{ brand.name }}
          </span>
          {% endfor %}
          {% else %}
          <span class="text-[9px] font-bold italic text-slate-400 uppercase tracking-tighter">No subsidiary brands
            linked.</span>
          {% endif %}
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="px-6 py-4 border-t border-slate-100 flex gap-3">
        <button onclick="addEquipment('{{ company.id }}')"
          class="flex-1 py-2 bg-white border border-slate-100 text-slate-600 rounded-xl text-[9px] font-black uppercase tracking-widest transition-all hover:bg-slate-50 hover:border-slate-200 shadow-sm">+
          EQUIP</button>
        <button onclick="addReagent('{{ company.id }}')"
          class="flex-1 py-2 bg-white border border-slate-100 text-slate-600 rounded-xl text-[9px] font-black uppercase tracking-widest transition-all hover:bg-slate-50 hover:border-slate-200 shadow-sm">+
          REAG</button>
        <button onclick="addMaterial('{{ company.id }}')"
          class="flex-1 py-2 bg-white border border-slate-100 text-slate-600 rounded-xl text-[9px] font-black uppercase tracking-widest transition-all hover:bg-slate-50 hover:border-slate-200 shadow-sm">+
          MAT</button>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="py-16 text-center bg-white rounded border border-dashed border-gray-300">
    <div class="w-12 h-12 bg-gray-50 text-gray-200 rounded-full flex items-center justify-center mx-auto mb-4 border">
      <i class="fas fa-building text-xl"></i>
    </div>
    <h3 class="text-sm font-bold text-gray-900">No Registered Workspace Entities</h3>
    <p class="text-gray-500 text-xs mt-1 mb-8">Initialize your organization profile to begin document generation.</p>
    <button onclick="openModal('addCompanyModal')"
      class="px-6 py-2 bg-[#1e40af] text-white rounded text-[10px] font-bold uppercase hover:bg-blue-800 transition-all shadow-xl shadow-indigo-100">
      REGISTER FIRST ENTITY
    </button>
  </div>
  {% endif %}

</div><!-- End of main container -->

<!-- Global Modals Cluster -->
<div id="addCompanyModal"
  class="fixed inset-0 z-[9999] hidden items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4">
  <div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-lg overflow-hidden transition-all duration-300">
    <div class="flex justify-between items-center px-8 py-5 border-b border-slate-50 bg-slate-50/30">
      <div>
        <h3 class="text-lg font-display font-black text-slate-900">Initialize Entity</h3>
        <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mt-0.5">Pharmaceutical Workspace
          Registration</p>
      </div>
      <button onclick="closeModal('addCompanyModal')"
        class="w-10 h-10 bg-white border border-slate-100 text-slate-400 rounded-xl hover:bg-rose-50 hover:text-rose-500 flex items-center justify-center transition-all">
        <i class="fas fa-times text-xs"></i>
      </button>
    </div>
    <form id="addCompanyForm" class="p-8 space-y-5" enctype="multipart/form-data">
      <div class="space-y-1.5">
        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Organization Name</label>
        <input type="text" name="name" required
          class="w-full bg-slate-50 border border-slate-100 rounded-2xl py-3 px-4 text-sm font-bold text-slate-700 placeholder:text-slate-300 focus:bg-white focus:border-indigo-300 focus:ring-4 focus:ring-indigo-50 transition-all outline-none">
      </div>
      <div class="space-y-1.5">
        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Operational
          Headquarters</label>
        <textarea name="address"
          class="w-full bg-slate-50 border border-slate-100 rounded-2xl py-3 px-4 text-sm font-bold text-slate-700 placeholder:text-slate-300 focus:bg-white focus:border-indigo-300 focus:ring-4 focus:ring-indigo-50 transition-all outline-none min-h-[100px]"></textarea>
      </div>
      <div class="space-y-1.5">
        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Branding Identity
          (Logo)</label>
        <div class="relative group">
          <input type="file" name="logo" accept="image/*"
            class="w-full text-xs text-slate-500 file:mr-4 file:py-2.5 file:px-4 file:rounded-xl file:border-0 file:text-[10px] file:font-black file:uppercase file:bg-indigo-50 file:text-indigo-600 hover:file:bg-indigo-100 transition-all">
        </div>
      </div>
      <div class="pt-6 border-t border-slate-50 flex gap-4">
        <button type="button" onclick="closeModal('addCompanyModal')"
          class="flex-1 py-3 text-[10px] font-black uppercase bg-slate-50 text-slate-400 rounded-2xl hover:bg-slate-100 transition-all tracking-widest">Discard</button>
        <button type="submit"
          class="flex-[2] py-3 text-[10px] font-black uppercase bg-[#1e40af] text-white rounded-2xl hover:bg-blue-800 shadow-xl shadow-indigo-100 transition-all tracking-widest">Establish
          Workspace</button>
      </div>
    </form>
  </div>
</div>

<div id="editCompanyModal"
  class="fixed inset-0 z-[9999] hidden items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4">
  <div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-lg overflow-hidden transition-all duration-300">
    <div class="flex justify-between items-center px-8 py-5 border-b border-slate-50 bg-slate-50/30">
      <div>
        <h3 class="text-lg font-display font-black text-slate-900">Modify Identity</h3>
        <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mt-0.5">GXP Compliant Protocol Update
        </p>
      </div>
      <button onclick="closeModal('editCompanyModal')"
        class="w-10 h-10 bg-white border border-slate-100 text-slate-400 rounded-xl hover:bg-rose-50 hover:text-rose-500 flex items-center justify-center transition-all">
        <i class="fas fa-times text-xs"></i>
      </button>
    </div>
    <form id="editCompanyForm" class="p-8 space-y-5" enctype="multipart/form-data">
      <input type="hidden" id="editCompanyId" name="company_id">
      <div class="space-y-1.5">
        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Entity Name</label>
        <input type="text" id="editCompanyName" name="name" required
          class="w-full bg-slate-50 border border-slate-100 rounded-2xl py-3 px-4 text-sm font-bold text-slate-700 placeholder:text-slate-300 focus:bg-white focus:border-indigo-300 focus:ring-4 focus:ring-indigo-50 transition-all outline-none">
      </div>
      <div class="space-y-1.5">
        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Operational Address</label>
        <textarea id="editCompanyAddress" name="address"
          class="w-full bg-slate-50 border border-slate-100 rounded-2xl py-3 px-4 text-sm font-bold text-slate-700 placeholder:text-slate-300 focus:bg-white focus:border-indigo-300 focus:ring-4 focus:ring-indigo-50 transition-all outline-none min-h-[100px]"></textarea>
      </div>
      <div class="space-y-1.5">
        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Asset Upgrade (Logo)</label>
        <div class="relative group">
          <input type="file" name="logo" accept="image/*"
            class="w-full text-xs text-slate-500 file:mr-4 file:py-2.5 file:px-4 file:rounded-xl file:border-0 file:text-[10px] file:font-black file:uppercase file:bg-indigo-50 file:text-indigo-600 hover:file:bg-indigo-100 transition-all">
        </div>
      </div>
      <div class="pt-6 border-t border-slate-50 flex gap-4">
        <button type="button" onclick="closeModal('editCompanyModal')"
          class="flex-1 py-3 text-[10px] font-black uppercase bg-slate-50 text-slate-400 rounded-2xl hover:bg-slate-100 transition-all tracking-widest">Discard</button>
        <button type="submit"
          class="flex-[2] py-3 text-[10px] font-black uppercase bg-[#1e40af] text-white rounded-2xl hover:bg-blue-800 shadow-xl shadow-indigo-100 transition-all tracking-widest">Commit
          Policy</button>
      </div>
    </form>
  </div>
</div>

<div id="addSubBrandModal"
  class="fixed inset-0 z-[9999] hidden items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4">
  <div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-sm overflow-hidden transition-all duration-300">
    <div class="flex justify-between items-center px-8 py-5 border-b border-slate-50 bg-slate-50/30">
      <div>
        <h3 class="text-base font-display font-black text-slate-900">Append Subsidiary</h3>
        <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mt-0.5">Brand Hierarchy Expansion</p>
      </div>
      <button onclick="closeModal('addSubBrandModal')"
        class="w-10 h-10 bg-white border border-slate-100 text-slate-400 rounded-xl hover:bg-rose-50 hover:text-rose-500 flex items-center justify-center transition-all">
        <i class="fas fa-times text-xs"></i>
      </button>
    </div>
    <form id="addSubBrandForm" class="p-8 space-y-5">
      <input type="hidden" id="subBrandCompanyId" name="company_id">
      <div class="space-y-1.5">
        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Brand Designation</label>
        <input type="text" name="name" required
          class="w-full bg-slate-50 border border-slate-100 rounded-2xl py-3 px-4 text-sm font-bold text-slate-700 placeholder:text-slate-300 focus:bg-white focus:border-indigo-300 focus:ring-4 focus:ring-indigo-50 transition-all outline-none"
          placeholder="e.g. Quality Division">
      </div>
      <button type="submit"
        class="w-full py-3 text-[10px] font-black uppercase bg-[#1e40af] text-white rounded-2xl hover:bg-blue-800 shadow-xl shadow-indigo-100 transition-all tracking-widest">Link
        Identity</button>
    </form>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  function toggleRelDropdown(btn) {
    const menu = btn.closest('.dropdown-container').querySelector('.custom-dropdown');
    document.querySelectorAll('.custom-dropdown').forEach(d => { if (d !== menu) d.classList.add('hidden'); });
    menu.classList.toggle('hidden');
  }

  document.addEventListener('click', (e) => {
    if (!e.target.closest('.dropdown-container')) document.querySelectorAll('.custom-dropdown').forEach(d => d.classList.add('hidden'));
  });

  async function editCompany(id) {
    try {
      const res = await fetch(`/company/get/${id}`);
      const r = await res.json();
      if (!r.success) return alert('Retrieval Fault');
      document.getElementById('editCompanyId').value = r.company.id;
      document.getElementById('editCompanyName').value = r.company.name;
      document.getElementById('editCompanyAddress').value = r.company.address || '';
      openModal('editCompanyModal');
    } catch (err) { alert('System Error'); }
  }

  document.getElementById('addCompanyForm').addEventListener('submit', async function (e) {
    e.preventDefault();
    const btn = this.querySelector('button[type="submit"]');
    btn.disabled = true;
    try {
      const res = await fetch('/company/create', { method: 'POST', body: new FormData(this) });
      if ((await res.json()).success) location.reload(); else alert('Registration Failed');
    } catch (err) { alert('Communication Fault'); }
    finally { btn.disabled = false; }
  });

  document.getElementById('editCompanyForm').addEventListener('submit', async function (e) {
    e.preventDefault();
    const btn = this.querySelector('button[type="submit"]');
    btn.disabled = true;
    try {
      const id = document.getElementById('editCompanyId').value;
      const res = await fetch(`/company/edit/${id}`, { method: 'POST', body: new FormData(this) });
      if ((await res.json()).success) location.reload(); else alert('Commit Failed');
    } catch (err) { alert('Protocol Exception'); }
    finally { btn.disabled = false; }
  });

  function addSubBrand(id) {
    document.getElementById('subBrandCompanyId').value = id;
    document.getElementById('addSubBrandForm').reset();
    openModal('addSubBrandModal');
  }

  document.getElementById('addSubBrandForm').addEventListener('submit', async function (e) {
    e.preventDefault();
    const btn = this.querySelector('button[type="submit"]');
    btn.disabled = true;
    try {
      const res = await fetch('/subbrand/create', { method: 'POST', body: new FormData(this) });
      if ((await res.json()).success) location.reload(); else alert('Linking Fault');
    } catch (err) { alert('Network Failure'); }
    finally { btn.disabled = false; }
  });

  function fillCompanyDemo() {
    document.querySelector('#addCompanyForm [name="name"]').value = 'Ind-Swift Laboratories Ltd.';
    document.querySelector('#addCompanyForm [name="address"]').value = 'S.C.O. 850, NAC Manimajra, Chandigarh';
  }
</script>

<style>
  .custom-dropdown {
    transform-origin: top right;
  }
</style>
{% endblock %}