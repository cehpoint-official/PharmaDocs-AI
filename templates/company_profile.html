{% extends "base.html" %}
{% block title %}Workspace Management - PharmaDocs AI Platform{% endblock %}

{% block content %}
<!-- Modals Layer -->
<div id="addCompanyModal"
  class="fixed inset-0 z-[100] hidden items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm p-4">
  <div class="bg-white rounded shadow-2xl w-full max-w-xl border border-gray-200">
    <div class="flex justify-between items-center px-6 py-4 border-b bg-gray-50">
      <h3 class="text-[10px] font-black text-gray-800 uppercase tracking-widest">Register New Entity</h3>
      <button onclick="closeModal('addCompanyModal')"
        class="w-6 h-6 flex items-center justify-center text-gray-400 hover:text-red-600 transition-colors">
        <i class="fas fa-times text-xs"></i>
      </button>
    </div>
    <form id="addCompanyForm" class="p-6 space-y-4" enctype="multipart/form-data">
      <div class="space-y-1">
        <label class="text-[9px] font-black text-gray-500 uppercase">Primary Company Name</label>
        <input type="text" name="name" required
          class="w-full bg-white border border-gray-300 rounded px-3 py-2 text-xs focus:ring-1 focus:ring-blue-600 outline-none">
      </div>
      <div class="space-y-1">
        <label class="text-[9px] font-black text-gray-500 uppercase">Registered Address</label>
        <textarea name="address"
          class="w-full bg-white border border-gray-300 rounded px-3 py-2 text-xs focus:ring-1 focus:ring-blue-600 outline-none min-h-[80px]"></textarea>
      </div>
      <div class="space-y-1">
        <label class="text-[9px] font-black text-gray-500 uppercase">Brand Identity Asset</label>
        <input type="file" name="logo" accept="image/*"
          class="w-full text-[10px] text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-[10px] file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
      </div>
      <div class="pt-4 flex gap-2">
        <button type="button" onclick="closeModal('addCompanyModal')"
          class="flex-1 py-2 text-[10px] font-bold uppercase bg-gray-100 text-gray-600 rounded hover:bg-gray-200">Discard</button>
        <button type="submit"
          class="flex-[2] py-2 text-[10px] font-bold uppercase bg-[#1e40af] text-white rounded hover:bg-blue-800">Establish
          Workspace</button>
      </div>
    </form>
  </div>
</div>

<div id="editCompanyModal"
  class="fixed inset-0 z-[100] hidden items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm p-4">
  <div class="bg-white rounded shadow-2xl w-full max-w-xl border border-gray-200">
    <div class="flex justify-between items-center px-6 py-4 border-b bg-gray-50">
      <h3 class="text-[10px] font-black text-gray-800 uppercase tracking-widest">Update Identity</h3>
      <button onclick="closeModal('editCompanyModal')"
        class="w-6 h-6 flex items-center justify-center text-gray-400 hover:text-red-600 transition-colors">
        <i class="fas fa-times text-xs"></i>
      </button>
    </div>
    <form id="editCompanyForm" class="p-6 space-y-4" enctype="multipart/form-data">
      <input type="hidden" id="editCompanyId" name="company_id">
      <div class="space-y-1">
        <label class="text-[9px] font-black text-gray-500 uppercase">Company Name</label>
        <input type="text" id="editCompanyName" name="name" required
          class="w-full bg-white border border-gray-300 rounded px-3 py-2 text-xs focus:ring-1 focus:ring-blue-600 outline-none">
      </div>
      <div class="space-y-1">
        <label class="text-[9px] font-black text-gray-500 uppercase">Registered Address</label>
        <textarea id="editCompanyAddress" name="address"
          class="w-full bg-white border border-gray-300 rounded px-3 py-2 text-xs focus:ring-1 focus:ring-blue-600 outline-none min-h-[80px]"></textarea>
      </div>
      <div class="space-y-1">
        <label class="text-[9px] font-black text-gray-500 uppercase">Brand Asset Update</label>
        <input type="file" name="logo" accept="image/*"
          class="w-full text-[10px] text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-[10px] file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
      </div>
      <div class="pt-4 flex gap-2">
        <button type="button" onclick="closeModal('editCompanyModal')"
          class="flex-1 py-2 text-[10px] font-bold uppercase bg-gray-100 text-gray-600 rounded hover:bg-gray-200">Discard</button>
        <button type="submit"
          class="flex-[2] py-2 text-[10px] font-bold uppercase bg-[#1e40af] text-white rounded hover:bg-blue-800">Commit
          Policy</button>
      </div>
    </form>
  </div>
</div>

<div id="addSubBrandModal"
  class="fixed inset-0 z-[100] hidden items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm p-4">
  <div class="bg-white rounded shadow-2xl w-full max-w-sm border border-gray-200">
    <div class="flex justify-between items-center px-6 py-4 border-b bg-gray-50">
      <h3 class="text-[10px] font-black text-gray-800 uppercase tracking-widest">Append Sub-brand</h3>
      <button onclick="closeModal('addSubBrandModal')"
        class="w-6 h-6 flex items-center justify-center text-gray-400 hover:text-red-500 transition-colors">
        <i class="fas fa-times text-xs"></i>
      </button>
    </div>
    <form id="addSubBrandForm" class="p-6 space-y-4">
      <input type="hidden" id="subBrandCompanyId" name="company_id">
      <div class="space-y-1">
        <label class="text-[9px] font-black text-gray-500 uppercase">Brand Designation</label>
        <input type="text" name="name" required
          class="w-full bg-white border border-gray-300 rounded px-3 py-2 text-xs focus:ring-1 focus:ring-blue-600 outline-none"
          placeholder="e.g. Quality Division">
      </div>
      <button type="submit"
        class="w-full py-2 text-[10px] font-bold uppercase bg-[#1e40af] text-white rounded hover:bg-blue-800">Link Brand
        Hierarchy</button>
    </form>
  </div>
</div>
<div class="max-w-full mx-auto px-4 py-6">

  <!-- Compact Header -->
  <div class="mb-4 flex flex-col md:flex-row md:items-center justify-between gap-4 border-b pb-4">
    <div>
      <div class="flex items-center gap-1 text-[10px] font-bold text-gray-400 uppercase mb-1">
        <a href="{{ url_for('dashboard.user_dashboard') }}" class="hover:text-blue-700">APP</a>
        <i class="fas fa-chevron-right text-[7px]"></i>
        <span class="text-blue-700">Workspace Entities</span>
      </div>
      <h1 class="text-xl font-bold text-gray-900 leading-none">Organization Profile & Metadata</h1>
    </div>

    <div class="flex items-center gap-2">
      <button onclick="openModal('addCompanyModal')"
        class="px-3 py-1.5 bg-blue-700 text-white rounded text-[10px] font-bold uppercase hover:bg-blue-800 transition-all">
        <i class="fas fa-plus mr-1"></i> REGISTER ENTITY
      </button>
    </div>
  </div>

  {% if companies %}
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    {% for company in companies %}
    <div class="bg-white border rounded shadow-sm overflow-hidden flex flex-col">
      <!-- Entity Identity -->
      <div class="px-3 py-2 bg-gray-50 border-b flex items-center justify-between">
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 rounded border bg-white flex items-center justify-center overflow-hidden">
            {% if company.logo_url %}
            <img src="{{ company.logo_url }}" class="w-6 h-6 object-contain">
            {% else %}
            <i class="fas fa-building text-gray-300 text-xs"></i>
            {% endif %}
          </div>
          <div>
            <h4 class="text-sm font-bold text-gray-900 leading-tight">{{ company.name }}</h4>
            <p class="text-[9px] text-gray-400 font-bold uppercase">ID: ENT-{{ company.id }}</p>
          </div>
        </div>
        <div class="flex items-center gap-1">
          <button
            onclick="editCompany('{{ company.id }}', '{{ company.name }}', '{{ company.address }}', '{{ company.contact_info }}')"
            class="p-1.5 text-blue-600 hover:bg-blue-50 rounded transition-all">
            <i class="fas fa-edit text-[10px]"></i>
          </button>
          <button onclick="deleteCompany('{{ company.id }}', '{{ company.name }}')"
            class="p-1.5 text-red-600 hover:bg-red-50 rounded transition-all">
            <i class="fas fa-trash-alt text-[10px]"></i>
          </button>
        </div>
      </div>

      <div class="p-3 grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Data Cluster 1: Logistics -->
        <div class="space-y-2">
          <div class="flex items-start gap-2">
            <i class="fas fa-map-marker-alt text-gray-300 text-[10px] mt-0.5"></i>
            <div>
              <p class="text-[9px] font-black text-gray-400 uppercase leading-none">Registered Address</p>
              <p class="text-[11px] font-bold text-gray-600 mt-1">{{ company.address or 'UNSET' }}</p>
            </div>
          </div>
          <div class="flex items-start gap-2">
            <i class="fas fa-address-book text-gray-300 text-[10px] mt-0.5"></i>
            <div>
              <p class="text-[9px] font-black text-gray-400 uppercase leading-none">Support Contact</p>
              <p class="text-[11px] font-bold text-gray-600 mt-1">{{ company.contact_info or 'UNSET' }}</p>
            </div>
          </div>
        </div>

        <!-- Data Cluster 2: Resource Matrix -->
        <div class="bg-gray-50 border rounded p-2 flex flex-col justify-center">
          <p class="text-[9px] font-black text-gray-400 uppercase mb-2 px-1">Resource Index</p>
          <div class="grid grid-cols-3 gap-2 text-center">
            <div class="border-r last:border-0 pr-2">
              <p class="text-xs font-bold text-blue-700">{{ company.equipment_count or 0 }}</p>
              <p class="text-[8px] font-bold text-gray-400 uppercase">Equip</p>
            </div>
            <div class="border-r last:border-0 px-2">
              <p class="text-xs font-bold text-emerald-600">{{ company.reagent_count or 0 }}</p>
              <p class="text-[8px] font-bold text-gray-400 uppercase">Reag</p>
            </div>
            <div class="pl-2">
              <p class="text-xs font-bold text-purple-600">{{ company.material_count or 0 }}</p>
              <p class="text-[8px] font-bold text-gray-400 uppercase">Mat</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Sub-brands Integration -->
      <div class="px-3 py-2 bg-gray-50/50 border-t">
        <div class="flex items-center justify-between mb-2">
          <h5 class="text-[10px] font-black text-gray-500 uppercase">Registered Sub-brands</h5>
          <button onclick="addSubBrand('{{ company.id }}')" class="text-[9px] font-bold text-blue-700 hover:underline">+
            ADD BRAND</button>
        </div>
        <div class="flex flex-wrap gap-2">
          {% if company.brands %}
          {% for brand in company.brands %}
          <span
            class="inline-flex items-center gap-1 px-2 py-0.5 bg-white border border-gray-200 rounded text-[10px] font-bold text-gray-600">
            <i class="fas fa-tag text-[8px] text-gray-300"></i> {{ brand.name }}
          </span>
          {% endfor %}
          {% else %}
          <span class="text-[9px] italic text-gray-400">No subsidiary brands linked.</span>
          {% endif %}
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="px-3 py-2 border-t flex gap-2">
        <button onclick="addEquipment('{{ company.id }}')"
          class="flex-1 py-1 bg-gray-100 border text-gray-600 rounded text-[9px] font-bold uppercase transition-all hover:bg-white">+
          EQUIP</button>
        <button onclick="addReagent('{{ company.id }}')"
          class="flex-1 py-1 bg-gray-100 border text-gray-600 rounded text-[9px] font-bold uppercase transition-all hover:bg-white">+
          REAG</button>
        <button onclick="addMaterial('{{ company.id }}')"
          class="flex-1 py-1 bg-gray-100 border text-gray-600 rounded text-[9px] font-bold uppercase transition-all hover:bg-white">+
          MAT</button>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="py-16 text-center bg-white rounded border border-dashed border-gray-300">
    <div class="w-12 h-12 bg-gray-50 text-gray-200 rounded-full flex items-center justify-center mx-auto mb-4 border">
      <i class="fas fa-building text-xl"></i>
    </div>
    <h3 class="text-sm font-bold text-gray-900">No Registered Workspace Entities</h3>
    <p class="text-gray-500 text-xs mt-1 mb-8">Initialize your organization profile to begin document generation.</p>
    <button onclick="openModal('addCompanyModal')"
      class="px-6 py-2 bg-blue-700 text-white rounded text-[10px] font-bold uppercase hover:bg-blue-800 transition-all">
      REGISTER FIRST ENTITY
    </button>
  </div>
  {% endif %}

</div><!-- End of main container -->

<!-- Global Modals Cluster -->
<div id="addCompanyModal"
  class="fixed inset-0 z-[9999] hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
  <div class="bg-white rounded shadow-2xl w-full max-w-lg border border-gray-200">
    <div class="flex justify-between items-center px-6 py-4 border-b bg-gray-50/50">
      <h3 class="text-[10px] font-black text-gray-800 uppercase tracking-widest leading-none">Initialize New Entity</h3>
      <button onclick="closeModal('addCompanyModal')" class="text-gray-400 hover:text-red-600 transition-colors">
        <i class="fas fa-times text-xs"></i>
      </button>
    </div>
    <form id="addCompanyForm" class="p-6 space-y-4" enctype="multipart/form-data">
      <div class="space-y-1">
        <label class="text-[9px] font-black text-gray-500 uppercase">Organization Name</label>
        <input type="text" name="name" required
          class="w-full bg-white border border-gray-300 rounded px-3 py-2 text-xs focus:ring-1 focus:ring-blue-600 outline-none">
      </div>
      <div class="space-y-1">
        <label class="text-[9px] font-black text-gray-500 uppercase">Operational Headquarters</label>
        <textarea name="address"
          class="w-full bg-white border border-gray-300 rounded px-3 py-2 text-xs focus:ring-1 focus:ring-blue-600 outline-none min-h-[80px]"></textarea>
      </div>
      <div class="space-y-1">
        <label class="text-[9px] font-black text-gray-500 uppercase">Branding Identity (Logo)</label>
        <input type="file" name="logo" accept="image/*"
          class="w-full text-[10px] text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-[10px] file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
      </div>
      <div class="pt-4 flex gap-2">
        <button type="button" onclick="closeModal('addCompanyModal')"
          class="flex-1 py-2 text-[10px] font-bold uppercase bg-gray-50 text-gray-400 rounded hover:bg-gray-100 transition-all">Discard</button>
        <button type="submit"
          class="flex-[2] py-2 text-[10px] font-bold uppercase bg-[#1e40af] text-white rounded hover:bg-blue-800 shadow-md">Register
          Entity</button>
      </div>
    </form>
  </div>
</div>

<div id="editCompanyModal"
  class="fixed inset-0 z-[9999] hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
  <div class="bg-white rounded shadow-2xl w-full max-w-lg border border-gray-200">
    <div class="flex justify-between items-center px-6 py-4 border-b bg-gray-50/50">
      <h3 class="text-[10px] font-black text-gray-800 uppercase tracking-widest leading-none">Policy Configuration</h3>
      <button onclick="closeModal('editCompanyModal')" class="text-gray-400 hover:text-red-600 transition-colors">
        <i class="fas fa-times text-xs"></i>
      </button>
    </div>
    <form id="editCompanyForm" class="p-6 space-y-4" enctype="multipart/form-data">
      <input type="hidden" id="editCompanyId" name="company_id">
      <div class="space-y-1">
        <label class="text-[9px] font-black text-gray-500 uppercase">Entity Name</label>
        <input type="text" id="editCompanyName" name="name" required
          class="w-full bg-white border border-gray-300 rounded px-3 py-2 text-xs focus:ring-1 focus:ring-blue-600 outline-none">
      </div>
      <div class="space-y-1">
        <label class="text-[9px] font-black text-gray-500 uppercase">Operational Address</label>
        <textarea id="editCompanyAddress" name="address"
          class="w-full bg-white border border-gray-300 rounded px-3 py-2 text-xs focus:ring-1 focus:ring-blue-600 outline-none min-h-[80px]"></textarea>
      </div>
      <div class="space-y-1">
        <label class="text-[9px] font-black text-gray-500 uppercase">Asset Upgrade (Logo)</label>
        <input type="file" name="logo" accept="image/*"
          class="w-full text-[10px] text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-[10px] file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
      </div>
      <div class="pt-4 flex gap-2">
        <button type="button" onclick="closeModal('editCompanyModal')"
          class="flex-1 py-2 text-[10px] font-bold uppercase bg-gray-50 text-gray-400 rounded hover:bg-gray-100 transition-all">Discard</button>
        <button type="submit"
          class="flex-[2] py-2 text-[10px] font-bold uppercase bg-[#1e40af] text-white rounded hover:bg-blue-800 shadow-md">Commit
          Protocol</button>
      </div>
    </form>
  </div>
</div>

<div id="addSubBrandModal"
  class="fixed inset-0 z-[9999] hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
  <div class="bg-white rounded shadow-2xl w-full max-w-sm border border-gray-200 overflow-hidden">
    <div class="flex justify-between items-center px-6 py-4 border-b bg-gray-50/50">
      <h3 class="text-[10px] font-black text-gray-800 uppercase tracking-widest leading-none">Append Subsidiary</h3>
      <button onclick="closeModal('addSubBrandModal')" class="text-gray-400 hover:text-red-600 transition-colors">
        <i class="fas fa-times text-xs"></i>
      </button>
    </div>
    <form id="addSubBrandForm" class="p-6 space-y-4">
      <input type="hidden" id="subBrandCompanyId" name="company_id">
      <div class="space-y-1">
        <label class="text-[9px] font-black text-gray-500 uppercase">Brand Designation</label>
        <input type="text" name="name" required
          class="w-full bg-white border border-gray-300 rounded px-3 py-2 text-xs focus:ring-1 focus:ring-blue-600 outline-none"
          placeholder="e.g. Quality Division">
      </div>
      <button type="submit"
        class="w-full py-2 text-[10px] font-bold uppercase bg-[#1e40af] text-white rounded hover:bg-blue-800 shadow-md">Link
        Identity</button>
    </form>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  function toggleRelDropdown(btn) {
    const menu = btn.closest('.dropdown-container').querySelector('.custom-dropdown');
    document.querySelectorAll('.custom-dropdown').forEach(d => { if (d !== menu) d.classList.add('hidden'); });
    menu.classList.toggle('hidden');
  }

  document.addEventListener('click', (e) => {
    if (!e.target.closest('.dropdown-container')) document.querySelectorAll('.custom-dropdown').forEach(d => d.classList.add('hidden'));
  });

  async function editCompany(id) {
    try {
      const res = await fetch(`/company/get/${id}`);
      const r = await res.json();
      if (!r.success) return alert('Retrieval Fault');
      document.getElementById('editCompanyId').value = r.company.id;
      document.getElementById('editCompanyName').value = r.company.name;
      document.getElementById('editCompanyAddress').value = r.company.address || '';
      openModal('editCompanyModal');
    } catch (err) { alert('System Error'); }
  }

  document.getElementById('addCompanyForm').addEventListener('submit', async function (e) {
    e.preventDefault();
    const btn = this.querySelector('button[type="submit"]');
    btn.disabled = true;
    try {
      const res = await fetch('/company/create', { method: 'POST', body: new FormData(this) });
      if ((await res.json()).success) location.reload(); else alert('Registration Failed');
    } catch (err) { alert('Communication Fault'); }
    finally { btn.disabled = false; }
  });

  document.getElementById('editCompanyForm').addEventListener('submit', async function (e) {
    e.preventDefault();
    const btn = this.querySelector('button[type="submit"]');
    btn.disabled = true;
    try {
      const id = document.getElementById('editCompanyId').value;
      const res = await fetch(`/company/edit/${id}`, { method: 'POST', body: new FormData(this) });
      if ((await res.json()).success) location.reload(); else alert('Commit Failed');
    } catch (err) { alert('Protocol Exception'); }
    finally { btn.disabled = false; }
  });

  function addSubBrand(id) {
    document.getElementById('subBrandCompanyId').value = id;
    document.getElementById('addSubBrandForm').reset();
    openModal('addSubBrandModal');
  }

  document.getElementById('addSubBrandForm').addEventListener('submit', async function (e) {
    e.preventDefault();
    const btn = this.querySelector('button[type="submit"]');
    btn.disabled = true;
    try {
      const res = await fetch('/subbrand/create', { method: 'POST', body: new FormData(this) });
      if ((await res.json()).success) location.reload(); else alert('Linking Fault');
    } catch (err) { alert('Network Failure'); }
    finally { btn.disabled = false; }
  });

  function fillCompanyDemo() {
    document.querySelector('#addCompanyForm [name="name"]').value = 'Ind-Swift Laboratories Ltd.';
    document.querySelector('#addCompanyForm [name="address"]').value = 'S.C.O. 850, NAC Manimajra, Chandigarh';
  }
</script>

<style>
  .custom-dropdown {
    transform-origin: top right;
  }
</style>
{% endblock %}