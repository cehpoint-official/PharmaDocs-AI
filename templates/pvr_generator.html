<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PVR Report Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .content {
            padding: 30px;
        }
        
        .step {
            display: none;
            animation: fadeIn 0.3s;
        }
        
        .step.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            padding: 0 20px;
        }
        
        .step-item {
            flex: 1;
            text-align: center;
            padding: 15px;
            background: #f0f0f0;
            margin: 0 5px;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .step-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }
        
        .step-item.completed {
            background: #28a745;
            color: white;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .actions {
            margin-top: 30px;
            display: flex;
            justify-content: space-between;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border: 1px solid #ddd;
        }
        
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }
        
        .batch-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .batch-section h3 {
            color: #1e3c72;
            margin-bottom: 20px;
        }
        
        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        
        .success-message {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Process Validation Report Generator</h1>
            <p>Generate comprehensive PVR documents from templates</p>
        </div>
        
        <div class="content">
            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step-item active" data-step="1">1. Select Template</div>
                <div class="step-item" data-step="2">2. Product Info</div>
                <div class="step-item" data-step="3">3. Batch Results</div>
                <div class="step-item" data-step="4">4. Generate</div>
            </div>
            
            <!-- Step 1: Select Template -->
            <div id="step1" class="step active">
                <h2>Step 1: Select Product Template</h2>
                
                <div class="info-box">
                    <h3>üí° Template Selection</h3>
                    <p>Select a template to auto-fill equipment, sampling plans, and acceptance criteria. You'll only need to customize product-specific details and enter batch results.</p>
                </div>
                
                <div class="form-group">
                    <label>Product Type *</label>
                    <select id="templateType">
                        <option value="">-- Select Template --</option>
                        <option value="liquid_injection">Liquid Injection (Sterile)</option>
                        <option value="lyophilized">Lyophilized Injection (Coming Soon)</option>
                        <option value="tablet">Tablet (Coming Soon)</option>
                        <option value="capsule">Capsule (Coming Soon)</option>
                    </select>
                </div>
                
                <div class="actions">
                    <div></div>
                    <button class="btn btn-primary" onclick="loadTemplate()">Load Template ‚Üí</button>
                </div>
            </div>
            
            <!-- Step 2: Product Information -->
            <div id="step2" class="step">
                <h2>Step 2: Product Information</h2>
                
                <div class="row">
                    <div class="form-group">
                        <label>Product Name *</label>
                        <input type="text" id="productName" placeholder="e.g., Fluorouracil Injection BP">
                    </div>
                    
                    <div class="form-group">
                        <label>Strength *</label>
                        <input type="text" id="strength" placeholder="e.g., 50mg/ml, 20ml">
                    </div>
                </div>
                
                <div class="row">
                    <div class="form-group">
                        <label>Report Number *</label>
                        <input type="text" id="reportNo" placeholder="e.g., FU/PVR/001-00">
                    </div>
                    
                    <div class="form-group">
                        <label>Batch Size *</label>
                        <input type="text" id="batchSize" placeholder="e.g., 50.0 Litres (2500 vials)">
                    </div>
                </div>
                
                <div class="row">
                    <div class="form-group">
                        <label>Company Name</label>
                        <input type="text" id="companyName" value="Kwality Pharmaceuticals Limited">
                    </div>
                    
                    <div class="form-group">
                        <label>Company Address</label>
                        <input type="text" id="companyAddress" value="1-A, Industrial Area, Raja Ka Bagh, Tehsil Nurpur, Kangra-176201 (India)">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Storage Conditions</label>
                    <textarea id="storageConditions" placeholder="e.g., Store at temperature below 25¬∞C. Protect from light."></textarea>
                </div>
                
                <div class="info-box">
                    <p><strong>‚úÖ Pre-filled from template:</strong></p>
                    <ul>
                        <li>71 Equipment items</li>
                        <li>9 Process steps</li>
                        <li>11 Acceptance criteria</li>
                    </ul>
                </div>
                
                <div class="actions">
                    <button class="btn btn-secondary" onclick="prevStep()">‚Üê Back</button>
                    <button class="btn btn-primary" onclick="nextStep()">Next ‚Üí</button>
                </div>
            </div>
            
            <!-- Step 3: Batch Results -->
            <div id="step3" class="step">
                <h2>Step 3: Enter Batch Results (3 Batches)</h2>
                
                <div class="info-box">
                    <h3>üìù Instructions</h3>
                    <p>Enter the actual test results from your validation batches. Leave fields empty if test was not performed.</p>
                </div>
                
                <!-- Batch 1 -->
                <div class="batch-section">
                    <h3>Batch 1</h3>
                    
                    <div class="row">
                        <div class="form-group">
                            <label>Batch Number *</label>
                            <input type="text" id="batch1_no" placeholder="e.g., OI0330">
                        </div>
                        <div class="form-group">
                            <label>Manufacturing Date *</label>
                            <input type="date" id="batch1_mfg_date">
                        </div>
                        <div class="form-group">
                            <label>Mfg Date (Label) *</label>
                            <input type="text" id="batch1_mfg" placeholder="e.g., 08/2021">
                        </div>
                        <div class="form-group">
                            <label>Exp Date *</label>
                            <input type="text" id="batch1_exp" placeholder="e.g., 07/2024">
                        </div>
                    </div>
                    
                    <h4>Manufacturing - During Mixing</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>Time Point</th>
                                <th>pH</th>
                                <th>Assay (%)</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>10 minutes</td>
                                <td><input type="number" step="0.001" id="batch1_mix_ph_10" placeholder="9.012"></td>
                                <td><input type="number" step="0.1" id="batch1_mix_assay_10" placeholder="98.5"></td>
                                <td><input type="text" id="batch1_mix_desc_10" placeholder="Clear colourless solution"></td>
                            </tr>
                            <tr>
                                <td>15 minutes</td>
                                <td><input type="number" step="0.001" id="batch1_mix_ph_15" placeholder="9.034"></td>
                                <td><input type="number" step="0.1" id="batch1_mix_assay_15" placeholder="99.2"></td>
                                <td><input type="text" id="batch1_mix_desc_15" placeholder="Clear colourless solution"></td>
                            </tr>
                            <tr>
                                <td>20 minutes</td>
                                <td><input type="number" step="0.001" id="batch1_mix_ph_20" placeholder="9.012"></td>
                                <td><input type="number" step="0.1" id="batch1_mix_assay_20" placeholder="98.8"></td>
                                <td><input type="text"
                                    id="batch1_mix_desc_20" placeholder="Clear colourless solution"></td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <h4>Filling & Sealing</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>Stage</th>
                                <th>pH</th>
                                <th>Assay (%)</th>
                                <th>Leak Test</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Initial</td>
                                <td><input type="number" step="0.001" id="batch1_fill_ph_init" placeholder="9.043"></td>
                                <td><input type="number" step="0.1" id="batch1_fill_assay_init" placeholder="99.6"></td>
                                <td><input type="text" id="batch1_fill_leak_init" placeholder="Pass"></td>
                            </tr>
                            <tr>
                                <td>Middle</td>
                                <td><input type="number" step="0.001" id="batch1_fill_ph_mid" placeholder="8.914"></td>
                                <td><input type="number" step="0.1" id="batch1_fill_assay_mid" placeholder="99.4"></td>
                                <td><input type="text" id="batch1_fill_leak_mid" placeholder="Pass"></td>
                            </tr>
                            <tr>
                                <td>End</td>
                                <td><input type="number" step="0.001" id="batch1_fill_ph_end" placeholder="8.964"></td>
                                <td><input type="number" step="0.1" id="batch1_fill_assay_end" placeholder="99.9"></td>
                                <td><input type="text" id="batch1_fill_leak_end" placeholder="Pass"></td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <h4>Final Product Analysis</h4>
                    <div class="row">
                        <div class="form-group">
                            <label>pH</label>
                            <input type="number" step="0.001" id="batch1_final_ph" placeholder="9.024">
                        </div>
                        <div class="form-group">
                            <label>Assay (mg)</label>
                            <input type="number" id="batch1_final_assay" placeholder="996">
                        </div>
                        <div class="form-group">
                            <label>Extractable Volume (ml)</label>
                            <input type="number" step="0.1" id="batch1_final_vol" placeholder="20.1">
                        </div>
                        <div class="form-group">
                            <label>Particulate Matter 10-25Œºm</label>
                            <input type="number" id="batch1_final_pm_small" placeholder="834">
                        </div>
                        <div class="form-group">
                            <label>Particulate Matter ‚â•25Œºm</label>
                            <input type="number" id="batch1_final_pm_large" placeholder="11">
                        </div>
                    </div>
                </div>
                
                <!-- Batch 2 -->
                <div class="batch-section">
                    <h3>Batch 2</h3>
                    
                    <div class="row">
                        <div class="form-group">
                            <label>Batch Number *</label>
                            <input type="text" id="batch2_no" placeholder="e.g., OI0331">
                        </div>
                        <div class="form-group">
                            <label>Manufacturing Date *</label>
                            <input type="date" id="batch2_mfg_date">
                        </div>
                        <div class="form-group">
                            <label>Mfg Date (Label) *</label>
                            <input type="text" id="batch2_mfg" placeholder="e.g., 08/2021">
                        </div>
                        <div class="form-group">
                            <label>Exp Date *</label>
                            <input type="text" id="batch2_exp" placeholder="e.g., 07/2024">
                        </div>
                    </div>
                    
                    <h4>Manufacturing - During Mixing</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>Time Point</th>
                                <th>pH</th>
                                <th>Assay (%)</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>10 minutes</td>
                                <td><input type="number" step="0.001" id="batch2_mix_ph_10" placeholder="9.043"></td>
                                <td><input type="number" step="0.1" id="batch2_mix_assay_10" placeholder="99.6"></td>
                                <td><input type="text" id="batch2_mix_desc_10" placeholder="Clear colourless solution"></td>
                            </tr>
                            <tr>
                                <td>15 minutes</td>
                                <td><input type="number" step="0.001" id="batch2_mix_ph_15" placeholder="8.944"></td>
                                <td><input type="number" step="0.1" id="batch2_mix_assay_15" placeholder="99.8"></td>
                                <td><input type="text" id="batch2_mix_desc_15" placeholder="Clear colourless solution"></td>
                            </tr>
                            <tr>
                                <td>20 minutes</td>
                                <td><input type="number" step="0.001" id="batch2_mix_ph_20" placeholder="8.812"></td>
                                <td><input type="number" step="0.1" id="batch2_mix_assay_20" placeholder="99.4"></td>
                                <td><input type="text" id="batch2_mix_desc_20" placeholder="Clear colourless solution"></td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <h4>Filling & Sealing</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>Stage</th>
                                <th>pH</th>
                                <th>Assay (%)</th>
                                <th>Leak Test</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Initial</td>
                                <td><input type="number" step="0.001" id="batch2_fill_ph_init" placeholder="8.913"></td>
                                <td><input type="number" step="0.1" id="batch2_fill_assay_init" placeholder="99.8"></td>
                                <td><input type="text" id="batch2_fill_leak_init" placeholder="Pass"></td>
                            </tr>
                            <tr>
                                <td>Middle</td>
                                <td><input type="number" step="0.001" id="batch2_fill_ph_mid" placeholder="8.943"></td>
                                <td><input type="number" step="0.1" id="batch2_fill_assay_mid" placeholder="99.3"></td>
                                <td><input type="text" id="batch2_fill_leak_mid" placeholder="Pass"></td>
                            </tr>
                            <tr>
                                <td>End</td>
                                <td><input type="number" step="0.001" id="batch2_fill_ph_end" placeholder="8.973"></td>
                                <td><input type="number" step="0.1" id="batch2_fill_assay_end" placeholder="99.5"></td>
                                <td><input type="text" id="batch2_fill_leak_end" placeholder="Pass"></td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <h4>Final Product Analysis</h4>
                    <div class="row">
                        <div class="form-group">
                            <label>pH</label>
                            <input type="number" step="0.001" id="batch2_final_ph" placeholder="9.045">
                        </div>
                        <div class="form-group">
                            <label>Assay (mg)</label>
                            <input type="number" id="batch2_final_assay" placeholder="1008">
                        </div>
                        <div class="form-group">
                            <label>Extractable Volume (ml)</label>
                            <input type="number" step="0.1" id="batch2_final_vol" placeholder="20.1">
                        </div>
                        <div class="form-group">
                            <label>Particulate Matter 10-25Œºm</label>
                            <input type="number" id="batch2_final_pm_small" placeholder="1145">
                        </div>
                        <div class="form-group">
                            <label>Particulate Matter ‚â•25Œºm</label>
                            <input type="number" id="batch2_final_pm_large" placeholder="12">
                        </div>
                    </div>
                </div>
                
                <!-- Batch 3 -->
                <div class="batch-section">
                    <h3>Batch 3</h3>
                    
                    <div class="row">
                        <div class="form-group">
                            <label>Batch Number *</label>
                            <input type="text" id="batch3_no" placeholder="e.g., OI0332">
                        </div>
                        <div class="form-group">
                            <label>Manufacturing Date *</label>
                            <input type="date" id="batch3_mfg_date">
                        </div>
                        <div class="form-group">
                            <label>Mfg Date (Label) *</label>
                            <input type="text" id="batch3_mfg" placeholder="e.g., 08/2021">
                        </div>
                        <div class="form-group">
                            <label>Exp Date *</label>
                            <input type="text" id="batch3_exp" placeholder="e.g., 07/2024">
                        </div>
                    </div>
                    
                    <h4>Manufacturing - During Mixing</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>Time Point</th>
                                <th>pH</th>
                                <th>Assay (%)</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>10 minutes</td>
                                <td><input type="number" step="0.001" id="batch3_mix_ph_10" placeholder="9.033"></td>
                                <td><input type="number" step="0.1" id="batch3_mix_assay_10" placeholder="99.7"></td>
                                <td><input type="text" id="batch3_mix_desc_10" placeholder="Clear colourless solution"></td>
                            </tr>
                            <tr>
                                <td>15 minutes</td>
                                <td><input type="number" step="0.001" id="batch3_mix_ph_15" placeholder="8.916"></td>
                                <td><input type="number" step="0.1" id="batch3_mix_assay_15" placeholder="99.9"></td>
                                <td><input type="text" id="batch3_mix_desc_15" placeholder="Clear colourless solution"></td>
                            </tr>
                            <tr>
                                <td>20 minutes</td>
                                <td><input type="number" step="0.001" id="batch3_mix_ph_20" placeholder="8.945"></td>
                                <td><input type="number" step="0.1" id="batch3_mix_assay_20" placeholder="99.4"></td>
                                <td><input type="text" id="batch3_mix_desc_20" placeholder="Clear colourless solution"></td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <h4>Filling & Sealing</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>Stage</th>
                                <th>pH</th>
                                <th>Assay (%)</th>
                                <th>Leak Test</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Initial</td>
                                <td><input type="number" step="0.001" id="batch3_fill_ph_init" placeholder="9.012"></td>
                                <td><input type="number" step="0.1" id="batch3_fill_assay_init" placeholder="100.3"></td>
                                <td><input type="text" id="batch3_fill_leak_init" placeholder="Pass"></td>
                            </tr>
                            <tr>
                                <td>Middle</td>
                                <td><input type="number" step="0.001" id="batch3_fill_ph_mid" placeholder="9.045"></td>
                                <td><input type="number" step="0.1" id="batch3_fill_assay_mid" placeholder="99.9"></td>
                                <td><input type="text" id="batch3_fill_leak_mid" placeholder="Pass"></td>
                            </tr>
                            <tr>
                                <td>End</td>
                                <td><input type="number" step="0.001" id="batch3_fill_ph_end" placeholder="8.965"></td>
                                <td><input type="number" step="0.1" id="batch3_fill_assay_end" placeholder="99.8"></td>
                                <td><input type="text" id="batch3_fill_leak_end" placeholder="Pass"></td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <h4>Final Product Analysis</h4>
                    <div class="row">
                        <div class="form-group">
                            <label>pH</label>
                            <input type="number" step="0.001" id="batch3_final_ph" placeholder="9.037">
                        </div>
                        <div class="form-group">
                            <label>Assay (mg)</label>
                            <input type="number" id="batch3_final_assay" placeholder="994">
                        </div>
                        <div class="form-group">
                            <label>Extractable Volume (ml)</label>
                            <input type="number" step="0.1" id="batch3_final_vol" placeholder="20.1">
                        </div>
                        <div class="form-group">
                            <label>Particulate Matter 10-25Œºm</label>
                            <input type="number" id="batch3_final_pm_small" placeholder="454">
                        </div>
                        <div class="form-group">
                            <label>Particulate Matter ‚â•25Œºm</label>
                            <input type="number" id="batch3_final_pm_large" placeholder="21">
                        </div>
                    </div>
                </div>
                
                <div class="actions">
                    <button class="btn btn-secondary" onclick="prevStep()">‚Üê Back</button>
                    <button class="btn btn-primary" onclick="nextStep()">Next ‚Üí</button>
                </div>
            </div>
            
            <!-- Step 4: Generate Report -->
            <div id="step4" class="step">
                <h2>Step 4: Review & Generate Report</h2>
                
                <div class="info-box">
                    <h3>‚úÖ Ready to Generate</h3>
                    <p>Review your data and generate the comprehensive 26-page Process Validation Report.</p>
                </div>
                
                <div class="batch-section">
                    <h3>Summary</h3>
                    <p><strong>Product:</strong> <span id="summary_product">-</span></p>
                    <p><strong>Strength:</strong> <span id="summary_strength">-</span></p>
                    <p><strong>Batch Size:</strong> <span id="summary_batch_size">-</span></p>
                    <p><strong>Batches:</strong> <span id="summary_batches">-</span></p>
                    <p><strong>Equipment Items:</strong> 71 (Pre-filled from template)</p>
                    <p><strong>Process Steps:</strong> 9 (Pre-filled from template)</p>
                    <p><strong>Acceptance Criteria:</strong> 11 (Pre-filled from template)</p>
                </div>
                
                <div class="success-message" id="successMessage">
                    ‚úÖ PVR data saved successfully! You can now generate the PDF report.
                </div>
                
                <div class="actions">
                    <button class="btn btn-secondary" onclick="prevStep()">‚Üê Back</button>
                    <button class="btn btn-success" onclick="savePVRData()">üíæ Save PVR Data</button>
                    <button class="btn btn-primary" onclick="generatePDF()">üìÑ Generate PDF (26 pages)</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        let templateData = null;
        
        function showStep(step) {
            // Hide all steps
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.step-item').forEach(s => {
                s.classList.remove('active');
                if (parseInt(s.dataset.step) < step) {
                    s.classList.add('completed');
                }
            });
            
            // Show current step
            document.getElementById('step' + step).classList.add('active');
            document.querySelector(`.step-item[data-step="${step}"]`).classList.add('active');
            currentStep = step;
        }
        
        function nextStep() {
            if (currentStep < 4) {
                if (validateStep(currentStep)) {
                    showStep(currentStep + 1);
                    if (currentStep === 4) {
                        updateSummary();
                    }
                }
            }
        }
        
        function prevStep() {
            if (currentStep > 1) {
                showStep(currentStep - 1);
            }
        }
        
        function validateStep(step) {
            if (step === 1) {
                const templateType = document.getElementById('templateType').value;
                if (!templateType) {
                    alert('Please select a template type');
                    return false;
                }
            }
            if (step === 2) {
                const productName = document.getElementById('productName').value;
                const strength = document.getElementById('strength').value;
                const reportNo = document.getElementById('reportNo').value;
                const batchSize = document.getElementById('batchSize').value;
                
                if (!productName || !strength || !reportNo || !batchSize) {
                    alert('Please fill all required fields marked with *');
                    return false;
                }
            }
            if (step === 3) {
                const batch1_no = document.getElementById('batch1_no').value;
                const batch2_no = document.getElementById('batch2_no').value;
                const batch3_no = document.getElementById('batch3_no').value;
                
                if (!batch1_no || !batch2_no || !batch3_no) {
                    alert('Please enter batch numbers for all 3 batches');
                    return false;
                }
            }
            return true;
        }
        
        function loadTemplate() {
            const templateType = document.getElementById('templateType').value;
            if (!templateType) {
                alert('Please select a template type');
                return;
            }
            
            if (templateType !== 'liquid_injection') {
                alert('This template is coming soon! Please select "Liquid Injection" for now.');
                return;
            }
            
            fetch(`/validation/template/${templateType}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        templateData = data.template;
                        alert('‚úÖ Template loaded successfully!\n\n' +
                              '- 71 equipment items loaded\n' +
                              '- 9 process steps loaded\n' +
                              '- 11 acceptance criteria loaded');
                        nextStep();
                    } else {
                        alert('Error loading template: ' + data.message);
                    }
                })
                .catch(error => {
                    alert('Error: ' + error);
                });
        }
        
        function collectFormData() {
            return {
                // Template
                template: templateData,
                
                // Product Info
                productName: document.getElementById('productName').value,
                strength: document.getElementById('strength').value,
                reportNo: document.getElementById('reportNo').value,
                batchSize: document.getElementById('batchSize').value,
                companyName: document.getElementById('companyName').value,
                companyAddress: document.getElementById('companyAddress').value,
                storageConditions: document.getElementById('storageConditions').value,
                
                // Batch 1
                batch1: {
                    no: document.getElementById('batch1_no').value,
                    mfg_date: document.getElementById('batch1_mfg_date').value,
                    mfg: document.getElementById('batch1_mfg').value,
                    exp: document.getElementById('batch1_exp').value,
                    mixing: {
                        min_10: {
                            ph: document.getElementById('batch1_mix_ph_10').value,
                            assay: document.getElementById('batch1_mix_assay_10').value,
                            desc: document.getElementById('batch1_mix_desc_10').value
                        },
                        min_15: {
                            ph: document.getElementById('batch1_mix_ph_15').value,
                            assay: document.getElementById('batch1_mix_assay_15').value,
                            desc: document.getElementById('batch1_mix_desc_15').value
                        },
                        min_20: {
                            ph: document.getElementById('batch1_mix_ph_20').value,
                            assay: document.getElementById('batch1_mix_assay_20').value,
                            desc: document.getElementById('batch1_mix_desc_20').value
                        }
                    },
                    filling: {
                        initial: {
                            ph: document.getElementById('batch1_fill_ph_init').value,
                            assay: document.getElementById('batch1_fill_assay_init').value,
                            leak: document.getElementById('batch1_fill_leak_init').value
                        },
                        middle: {
                            ph: document.getElementById('batch1_fill_ph_mid').value,
                            assay: document.getElementById('batch1_fill_assay_mid').value,
                            leak: document.getElementById('batch1_fill_leak_mid').value
                        },
                        end: {
                            ph: document.getElementById('batch1_fill_ph_end').value,
                            assay: document.getElementById('batch1_fill_assay_end').value,
                            leak: document.getElementById('batch1_fill_leak_end').value
                        }
                    },
                    final: {
                        ph: document.getElementById('batch1_final_ph').value,
                        assay: document.getElementById('batch1_final_assay').value,
                        volume: document.getElementById('batch1_final_vol').value,
                        pm_small: document.getElementById('batch1_final_pm_small').value,
                        pm_large: document.getElementById('batch1_final_pm_large').value
                    }
                },
                
                // Batch 2
                batch2: {
                    no: document.getElementById('batch2_no').value,
                    mfg_date: document.getElementById('batch2_mfg_date').value,
                    mfg: document.getElementById('batch2_mfg').value,
                    exp: document.getElementById('batch2_exp').value,
                    mixing: {
                        min_10: {
                            ph: document.getElementById('batch2_mix_ph_10').value,
                            assay: document.getElementById('batch2_mix_assay_10').value,
                            desc: document.getElementById('batch2_mix_desc_10').value
                        },
                        min_15: {
                            ph: document.getElementById('batch2_mix_ph_15').value,
                            assay: document.getElementById('batch2_mix_assay_15').value,
                            desc: document.getElementById('batch2_mix_desc_15').value
                        },
                        min_20: {
                            ph: document.getElementById('batch2_mix_ph_20').value,
                            assay: document.getElementById('batch2_mix_assay_20').value,
                            desc: document.getElementById('batch2_mix_desc_20').value
                        }
                    },
                    filling: {
                        initial: {
                            ph: document.getElementById('batch2_fill_ph_init').value,
                            assay: document.getElementById('batch2_fill_assay_init').value,
                            leak: document.getElementById('batch2_fill_leak_init').value
                        },
                        middle: {
                            ph: document.getElementById('batch2_fill_ph_mid').value,
                            assay: document.getElementById('batch2_fill_assay_mid').value,
                            leak: document.getElementById('batch2_fill_leak_mid').value
                        },
                        end: {
                            ph: document.getElementById('batch2_fill_ph_end').value,
                            assay: document.getElementById('batch2_fill_assay_end').value,
                            leak: document.getElementById('batch2_fill_leak_end').value
                        }
                    },
                    final: {
                        ph: document.getElementById('batch2_final_ph').value,
                        assay: document.getElementById('batch2_final_assay').value,
                        volume: document.getElementById('batch2_final_vol').value,
                        pm_small: document.getElementById('batch2_final_pm_small').value,
                        pm_large: document.getElementById('batch2_final_pm_large').value
                    }
                },
                
                // Batch 3
                batch3: {
                    no: document.getElementById('batch3_no').value,
                    mfg_date: document.getElementById('batch3_mfg_date').value,
                    mfg: document.getElementById('batch3_mfg').value,
                    exp: document.getElementById('batch3_exp').value,
                    mixing: {
                        min_10: {
                            ph: document.getElementById('batch3_mix_ph_10').value,
                            assay: document.getElementById('batch3_mix_assay_10').value,
                            desc: document.getElementById('batch3_mix_desc_10').value
                        },
                        min_15: {
                            ph: document.getElementById('batch3_mix_ph_15').value,
                            assay: document.getElementById('batch3_mix_assay_15').value,
                            desc: document.getElementById('batch3_mix_desc_15').value
                        },
                        min_20: {
                            ph: document.getElementById('batch3_mix_ph_20').value,
                            assay: document.getElementById('batch3_mix_assay_20').value,
                            desc: document.getElementById('batch3_mix_desc_20').value
                        }
                    },
                    filling: {
                        initial: {
                            ph: document.getElementById('batch3_fill_ph_init').value,
                            assay: document.getElementById('batch3_fill_assay_init').value,
                            leak: document.getElementById('batch3_fill_leak_init').value
                        },
                        middle: {
                            ph: document.getElementById('batch3_fill_ph_mid').value,
                            assay: document.getElementById('batch3_fill_assay_mid').value,
                            leak: document.getElementById('batch3_fill_leak_mid').value
                        },
                        end: {
                            ph: document.getElementById('batch3_fill_ph_end').value,
                            assay: document.getElementById('batch3_fill_assay_end').value,
                            leak: document.getElementById('batch3_fill_leak_end').value
                        }
                    },
                    final: {
                        ph: document.getElementById('batch3_final_ph').value,
                        assay: document.getElementById('batch3_final_assay').value,
                        volume: document.getElementById('batch3_final_vol').value,
                        pm_small: document.getElementById('batch3_final_pm_small').value,
                        pm_large: document.getElementById('batch3_final_pm_large').value
                    }
                }
            };
        }
        
        function updateSummary() {
            document.getElementById('summary_product').textContent = document.getElementById('productName').value;
            document.getElementById('summary_strength').textContent = document.getElementById('strength').value;
            document.getElementById('summary_batch_size').textContent = document.getElementById('batchSize').value;
            
            const batch1 = document.getElementById('batch1_no').value;
            const batch2 = document.getElementById('batch2_no').value;
            const batch3 = document.getElementById('batch3_no').value;
            document.getElementById('summary_batches').textContent = `${batch1}, ${batch2}, ${batch3}`;
        }
        
        function savePVRData() {
            const data = collectFormData();
            
            fetch('/validation/report/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('successMessage').style.display = 'block';
                    alert('‚úÖ ' + data.message + '\nFile: ' + data.filename);
                } else {
                    alert('‚ùå Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('‚ùå Error saving data: ' + error);
            });
        }
        
        function generatePDF() {
            const data = collectFormData();

            if (!data.productName || !data.batch1.no) {
                alert('‚ö†Ô∏è Please fill all required data before generating PDF');
                 return;
           }

           const btn = event.target;
           const originalText = btn.innerHTML;
           btn.innerHTML = 'Generating PDF... ‚è≥';
           btn.disabled = true;

           fetch('/validation/report/generate-pdf', {
               method: 'POST',
               headers: {
                   'Content-Type': 'application/json',
               },
               body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('PDF generation failed');
                }
                return response.blob();

            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `PVR_${data.productName.replace(/\s+/g,'_')}_${new Date().getTime()}.pdf`; 
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);    
                document.body.removeChild(a);

                btn.innerHTML = originalText;
                btn.disabled = false;

                alert('‚úÖ PDF generated successfully!');
            })
            .catch(error => {
                console.error('Error:', error);
                alert('‚ùå Error generating PDF: ' + error.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }
    </script>
</body>
</html>