{% extends "base.html" %}
{% block title %}View PVR Report{% endblock %}
{% block content %}
<div class="container mx-auto px-4 py-8 max-w-6xl">
  <div class="bg-white rounded-lg shadow-md p-6">
    <!-- Header -->
    <div class="flex justify-between items-start mb-6">
      <div>
        <h2 class="text-2xl font-bold text-gray-800">
          <i class="fas fa-file-medical text-green-600 mr-2"></i>
          Process Validation Report #{{ report.id }}
        </h2>
        <p class="text-sm text-gray-500 mt-2">
          Generated: {{ report.created_at.strftime('%d %b %Y, %I:%M %p') }}
        </p>
        <p class="text-sm text-gray-500 mt-1">Template: <strong>{{ report.template.product_name }}</strong></p>
        <p class="text-sm text-gray-500 mt-1">
          Product: <strong>{{ report.meta.product_name or report.template.product_name }}</strong>
          &nbsp;|&nbsp; Protocol: <strong>{{ report.meta.protocol_no or report.template.protocol_no }}</strong>
        </p>
      </div>
      <div class="flex gap-2">
        <a href="{{ url_for('pv.download_pvr_pdf', report_id=report.id) }}" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg">
          <i class="fas fa-download mr-2"></i>Download PDF
        </a>
        {% if report.word_filepath %}
        <a href="{{ url_for('pv.download_pvr_word', report_id=report.id) }}" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
          <i class="fas fa-file-word mr-2"></i>Download Word
        </a>
        {% endif %}
        <a href="{{ url_for('pv.view_pvp_template', template_id=report.template.id) }}" class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Back to Template</a>
      </div>
    </div>

    <!-- Summary -->
    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded mb-6">
      <h3 class="text-lg font-semibold text-gray-800 mb-2"><i class="fas fa-info-circle text-blue-600 mr-2"></i>Report Summary</h3>
      <div class="grid md:grid-cols-3 gap-4 mt-4">
        <div><p class="text-sm text-gray-600">Total Batches</p><p class="text-2xl font-bold">{{ report.batches|length }}</p></div>
        <div><p class="text-sm text-gray-600">Test Parameters</p><p class="text-2xl font-bold">{{ report.test_ids|length }}</p></div>
        <div><p class="text-sm text-gray-600">Total Data Points</p><p class="text-2xl font-bold">{{ report.data|length }}</p></div>
      </div>
    </div>

    <!-- Batch Data Table -->
    <div>
      <h3 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-table text-purple-600 mr-2"></i>Validation Data</h3>
      {% set batches = report.batches %}
      {% set test_ids = report.test_ids %}
      <div class="overflow-x-auto">
        <table class="min-w-full bg-white border border-gray-300 rounded-lg">
          <thead><tr class="bg-gray-800 text-white"><th class="px-4 py-3 text-left">Test Parameter</th>{% for b in batches %}<th class="px-4 py-3 text-center">{{ b.batch_number }}</th>{% endfor %}</tr></thead>
          <tbody>
            {% for test in test_ids %}
            <tr class="border-t hover:bg-gray-50 {% if loop.index % 2 == 0 %}bg-gray-50{% endif %}">
              <td class="px-4 py-3 font-medium text-gray-800">{{ test | replace('_',' ') | title }}</td>
              {% for b in batches %}
                <td class="px-4 py-3 text-center">
                  {% set r = report.data | selectattr('test_id','equalto',test) | selectattr('batch_number','equalto',b.batch_number) | first %}
                  {% if r %}
                    <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium">{{ r.test_result }}</span>
                  {% else %}
                    <span class="text-gray-400">-</span>
                  {% endif %}
                </td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Materials & Equipment -->
    <div class="grid md:grid-cols-2 gap-6 mt-6">

      <!-- Materials -->
      <div>
        <h4 class="font-semibold text-lg mb-2">Materials / Reagents</h4>
        {% if report.materials_tables %}
        <table class="w-full text-sm border-collapse border">
          <thead class="bg-gray-100">
            <tr>
              <th class="border px-2 py-1">Type</th>
              <th class="border px-2 py-1">Name</th>
              <th class="border px-2 py-1">Specification</th>
              <th class="border px-2 py-1">Quantity</th>
            </tr>
          </thead>
          <tbody>
            {% for mat in report.materials_tables %}
            <tr>
              <td class="border px-2 py-1">{{ mat.material_type }}</td>
              <td class="border px-2 py-1">{{ mat.material_name }}</td>
              <td class="border px-2 py-1">{{ mat.specification }}</td>
              <td class="border px-2 py-1">{{ mat.quantity }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
          <p class="text-sm text-gray-500">No materials recorded.</p>
        {% endif %}
      </div>

      <!-- Equipment -->
      <div>
        <h4 class="font-semibold text-lg mb-2">Equipment</h4>
        {% if report.equipment_tables %}
        <table class="w-full text-sm border-collapse border">
          <thead class="bg-gray-100">
            <tr>
              <th class="border px-2 py-1">Equipment ID</th>
              <th class="border px-2 py-1">Name</th>
              <th class="border px-2 py-1">Type</th>
              <th class="border px-2 py-1">Qualification</th>
              <th class="border px-2 py-1">Location</th>
            </tr>
          </thead>
          <tbody>
            {% for eq in report.equipment_tables %}
            <tr>
              <td class="border px-2 py-1">{{ eq.equipment_id }}</td>
              <td class="border px-2 py-1">{{ eq.equipment_name }}</td>
              <td class="border px-2 py-1">{{ eq.equipment_type }}</td>
              <td class="border px-2 py-1">{{ eq.qualification_status }}</td>
              <td class="border px-2 py-1">{{ eq.location }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
          <p class="text-sm text-gray-500">No equipment recorded.</p>
        {% endif %}
      </div>

    </div>


    <!-- Calculations -->
    <div class="mt-6">
      <h3 class="font-semibold">Calculated Summary</h3>
      {% if report.calculations %}
        <ul class="mt-2">
          {% for k,v in report.calculations.items() %}
            <li class="text-sm"><strong>{{ k|replace('_',' ')|title }}:</strong> {{ v }}</li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-sm text-gray-500">No calculations available.</p>
      {% endif %}
    </div>

    <!-- Raw JSON (toggle) -->
    <div class="mt-6 bg-gray-50 p-3 rounded text-xs text-gray-600">
      <details><summary>Raw extracted JSON - click to view</summary>
      <pre class="whitespace-pre-wrap mt-2">{{ report.extracted | tojson(indent=2) }}</pre>
      </details>
    </div>

    {% if report.generated_filepath %}
    <div class="mt-6 bg-green-50 border-l-4 border-green-500 p-4 rounded">
      <div class="flex items-center">
        <div class="ml-3">
          <p class="text-sm text-green-700"><strong>PDF Report Generated Successfully!</strong><br>File: {{ report.generated_filepath.split('/')[-1] }}</p>
        </div>
        <div class="ml-auto">
          <a href="{{ url_for('pv.download_pvr_pdf', report_id=report.id) }}" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded transition"><i class="fas fa-download mr-1"></i>Download</a>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}
